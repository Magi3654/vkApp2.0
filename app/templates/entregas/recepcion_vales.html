{% extends "base.html" %}

{% block title %}Recepción de Vales - Kinessia Hub{% endblock %}

{% block page_styles %}
<style>
.recepcion-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.5rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
}

.page-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.page-title .icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.page-title h1 {
    margin: 0;
    font-size: 1.5rem;
    color: #1f2937;
}

.page-title p {
    margin: 0;
    color: #6b7280;
    font-size: 0.9rem;
}

/* Stats */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-card .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.stat-card.pendientes .stat-icon { background: #fef3c7; color: #d97706; }
.stat-card.custodia .stat-icon { background: #dbeafe; color: #2563eb; }
.stat-card.monto .stat-icon { background: #d1fae5; color: #059669; }

.stat-card .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
}

.stat-card .stat-label {
    font-size: 0.85rem;
    color: #6b7280;
}

/* Tabla de vales */
.vales-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}

.section-header {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #f59e0b;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-header i {
    color: #d97706;
    font-size: 1.25rem;
}

.section-header h2 {
    margin: 0;
    font-size: 1.1rem;
    color: #92400e;
}

.section-header .count {
    margin-left: auto;
    background: #d97706;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.vales-table {
    width: 100%;
    border-collapse: collapse;
}

.vales-table th {
    background: #f9fafb;
    padding: 1rem;
    text-align: left;
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6b7280;
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;
}

.vales-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
}

.vales-table tr:hover {
    background: #f9fafb;
}

.folio-badge {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.9rem;
    display: inline-block;
}

.agente-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.agente-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
}

.agente-nombre {
    font-weight: 600;
    color: #1f2937;
}

.monto-cell {
    font-family: 'Monaco', 'Consolas', monospace;
    font-weight: 700;
    font-size: 1.1rem;
    color: #059669;
}

.monto-cell.dolares {
    color: #0891b2;
    font-size: 0.9rem;
}

.tiempo-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.tiempo-badge.reciente {
    background: #d1fae5;
    color: #065f46;
}

.tiempo-badge.espera {
    background: #fef3c7;
    color: #92400e;
}

.tiempo-badge.urgente {
    background: #fee2e2;
    color: #991b1b;
}

.btn-recibir {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-recibir:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
}

.btn-ver {
    background: white;
    color: #6b7280;
    padding: 0.5rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-ver:hover {
    border-color: #d1d5db;
    color: #374151;
}

.acciones-cell {
    display: flex;
    gap: 0.5rem;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
}

.empty-state i {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}

.empty-state h3 {
    margin: 0 0 0.5rem;
    color: #374151;
}

/* Modal confirmación */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
}

.modal-header {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.8;
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: 1.5rem;
}

.vale-resumen {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.vale-resumen-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px dashed #e5e7eb;
}

.vale-resumen-row:last-child {
    border-bottom: none;
    padding-top: 0.75rem;
    margin-top: 0.5rem;
    border-top: 2px solid #e5e7eb;
    font-weight: 700;
}

.vale-resumen-row .label {
    color: #6b7280;
}

.vale-resumen-row .value {
    font-weight: 600;
    color: #1f2937;
}

.vale-resumen-row .value.total {
    color: #059669;
    font-size: 1.25rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #374151;
}

.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    resize: vertical;
}

.form-group textarea:focus {
    border-color: #059669;
    outline: none;
}

.confirmacion-check {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    background: #ecfdf5;
    border: 2px solid #059669;
    border-radius: 8px;
    padding: 1rem;
}

.confirmacion-check input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    accent-color: #059669;
}

.confirmacion-check label {
    color: #065f46;
    font-weight: 500;
    cursor: pointer;
}

.modal-footer {
    padding: 1rem 1.5rem;
    background: #f9fafb;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.btn-cancelar {
    padding: 0.75rem 1.5rem;
    background: white;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}

.btn-confirmar {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-confirmar:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .vales-table thead { display: none; }
    .vales-table tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }
    .vales-table td {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 1rem;
    }
    .vales-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #6b7280;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="recepcion-container">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title">
            <span class="icon"><i class="fas fa-hand-holding-usd"></i></span>
            <div>
                <h1>Recepción de Vales</h1>
                <p>Confirma la recepción física del efectivo</p>
            </div>
        </div>
        <a href="{{ url_for('main.lista_entregas') }}" class="btn-ver">
            <i class="fas fa-list"></i> Ver Todas las Entregas
        </a>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card pendientes">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div>
                <div class="stat-value">{{ vales_pendientes|length }}</div>
                <div class="stat-label">Pendientes de Recibir</div>
            </div>
        </div>
        <div class="stat-card monto">
            <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
            <div>
                <div class="stat-value">${{ '{:,.0f}'.format(total_pendiente) }}</div>
                <div class="stat-label">Total por Recibir</div>
            </div>
        </div>
        <div class="stat-card custodia">
            <div class="stat-icon"><i class="fas fa-box"></i></div>
            <div>
                <div class="stat-value">{{ en_custodia }}</div>
                <div class="stat-label">En Mi Custodia</div>
            </div>
        </div>
    </div>

    <!-- Tabla de Vales Pendientes -->
    <div class="vales-section">
        <div class="section-header">
            <i class="fas fa-inbox"></i>
            <h2>Vales Pendientes de Recepción</h2>
            <span class="count">{{ vales_pendientes|length }}</span>
        </div>

        {% if vales_pendientes %}
        <table class="vales-table">
            <thead>
                <tr>
                    <th>Folio</th>
                    <th>Agente</th>
                    <th>Fecha</th>
                    <th>Efectivo MXN</th>
                    <th>Dólares</th>
                    <th>Total Físico</th>
                    <th>Tiempo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for vale in vales_pendientes %}
                <tr>
                    <td data-label="Folio">
                        <span class="folio-badge">{{ vale.folio }}</span>
                    </td>
                    <td data-label="Agente">
                        <div class="agente-info">
                            <div class="agente-avatar">
                                {{ vale.agente.nombre[0] if vale.agente else '?' }}
                            </div>
                            <span class="agente-nombre">{{ vale.agente.nombre if vale.agente else '---' }}</span>
                        </div>
                    </td>
                    <td data-label="Fecha">{{ vale.fecha.strftime('%d/%m/%Y') }}</td>
                    <td data-label="Efectivo" class="monto-cell">
                        ${{ '{:,.2f}'.format(vale.efectivo_pesos|float) }}
                    </td>
                    <td data-label="Dólares">
                        {% if vale.efectivo_dolares > 0 %}
                        <span class="monto-cell dolares">${{ '{:,.2f}'.format(vale.efectivo_dolares|float) }} USD</span>
                        {% else %}
                        <span style="color: #9ca3af;">-</span>
                        {% endif %}
                    </td>
                    <td data-label="Total" class="monto-cell">
                        ${{ '{:,.2f}'.format(vale.total_fisico|float) }}
                    </td>
                    <td data-label="Tiempo">
                        {% set horas = ((now - vale.fecha_hora_creacion).total_seconds() / 3600)|int if vale.fecha_hora_creacion else 0 %}
                        {% if horas < 2 %}
                        <span class="tiempo-badge reciente"><i class="fas fa-check"></i> Reciente</span>
                        {% elif horas < 8 %}
                        <span class="tiempo-badge espera"><i class="fas fa-clock"></i> {{ horas }}h</span>
                        {% else %}
                        <span class="tiempo-badge urgente"><i class="fas fa-exclamation-triangle"></i> {{ horas }}h</span>
                        {% endif %}
                    </td>
                    <td data-label="Acciones" class="acciones-cell">
                        <button type="button" class="btn-recibir" onclick="mostrarModalRecibir({{ vale.id }}, '{{ vale.folio }}', '{{ vale.agente.nombre if vale.agente else '---' }}', {{ vale.efectivo_pesos|float }}, {{ vale.efectivo_dolares|float }}, {{ vale.total_fisico|float }})">
                            <i class="fas fa-check"></i> Recibir
                        </button>
                        <a href="{{ url_for('main.ver_entrega', id=vale.id) }}" class="btn-ver">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No hay vales pendientes</h3>
            <p>Todos los vales han sido recibidos</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Confirmación -->
<div id="modalRecibir" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-hand-holding-usd"></i> Confirmar Recepción</h3>
            <button type="button" class="modal-close" onclick="cerrarModal()">&times;</button>
        </div>
        <form id="formRecibir" method="POST">
            <div class="modal-body">
                <div class="vale-resumen">
                    <div class="vale-resumen-row">
                        <span class="label">Folio</span>
                        <span class="value" id="modalFolio">-</span>
                    </div>
                    <div class="vale-resumen-row">
                        <span class="label">Agente</span>
                        <span class="value" id="modalAgente">-</span>
                    </div>
                    <div class="vale-resumen-row">
                        <span class="label">Efectivo MXN</span>
                        <span class="value" id="modalEfectivo">-</span>
                    </div>
                    <div class="vale-resumen-row" id="rowDolares" style="display: none;">
                        <span class="label">Dólares USD</span>
                        <span class="value" id="modalDolares">-</span>
                    </div>
                    <div class="vale-resumen-row">
                        <span class="label">TOTAL A RECIBIR</span>
                        <span class="value total" id="modalTotal">-</span>
                    </div>
                </div>

                <div class="confirmacion-check">
                    <input type="checkbox" id="checkConfirmar" onchange="validarFormulario()">
                    <label for="checkConfirmar">
                        Confirmo que he recibido físicamente el efectivo indicado y lo tengo en mi poder.
                    </label>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label>Notas (opcional)</label>
                    <textarea name="notas" rows="2" placeholder="Observaciones sobre la recepción..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-confirmar" id="btnConfirmar" disabled>
                    <i class="fas fa-check-circle"></i> Confirmar Recepción
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function mostrarModalRecibir(id, folio, agente, efectivo, dolares, total) {
    document.getElementById('formRecibir').action = '/entregas/' + id + '/recibir';
    document.getElementById('modalFolio').textContent = folio;
    document.getElementById('modalAgente').textContent = agente;
    document.getElementById('modalEfectivo').textContent = '$' + efectivo.toLocaleString('es-MX', {minimumFractionDigits: 2});
    document.getElementById('modalTotal').textContent = '$' + total.toLocaleString('es-MX', {minimumFractionDigits: 2});
    
    if (dolares > 0) {
        document.getElementById('rowDolares').style.display = 'flex';
        document.getElementById('modalDolares').textContent = '$' + dolares.toLocaleString('es-MX', {minimumFractionDigits: 2}) + ' USD';
    } else {
        document.getElementById('rowDolares').style.display = 'none';
    }
    
    document.getElementById('checkConfirmar').checked = false;
    document.getElementById('btnConfirmar').disabled = true;
    document.getElementById('modalRecibir').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modalRecibir').style.display = 'none';
}

function validarFormulario() {
    var checked = document.getElementById('checkConfirmar').checked;
    document.getElementById('btnConfirmar').disabled = !checked;
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') cerrarModal();
});

// Cerrar modal al hacer clic fuera
document.getElementById('modalRecibir').addEventListener('click', function(e) {
    if (e.target === this) cerrarModal();
});
</script>
{% endblock %}