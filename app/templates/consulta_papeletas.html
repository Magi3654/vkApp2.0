{% extends "base.html" %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_consulta_papeletas.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
/* Botón de impresión de ticket */
.btn-action.btn-print {
    background: linear-gradient(135deg, var(--color-purple, #8b5cf6) 0%, var(--color-purple-dark, #7c3aed) 100%);
    color: var(--white, #ffffff);
}
.btn-action.btn-print:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

/* === SECCIÓN ARCHIVO PDF EN MODAL === */
.archivo-section-modal {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px dashed #3b82f6;
    border-radius: 12px;
    padding: 1rem;
    margin: 1rem 0;
}
.archivo-section-modal.has-file {
    border-style: solid;
    border-color: #10b981;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
}
.archivo-section-modal h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.9rem;
    color: #1e40af;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.archivo-section-modal.has-file h4 {
    color: #065f46;
}
.archivo-actions-modal {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}
.btn-archivo-modal {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}
.btn-ver-pdf-modal {
    background: #3b82f6;
    color: white;
}
.btn-ver-pdf-modal:hover {
    background: #2563eb;
    transform: translateY(-1px);
}
.btn-descargar-modal {
    background: #10b981;
    color: white;
}
.btn-descargar-modal:hover {
    background: #059669;
    transform: translateY(-1px);
}
.btn-subir-modal {
    background: #f59e0b;
    color: white;
}
.btn-subir-modal:hover {
    background: #d97706;
    transform: translateY(-1px);
}
.archivo-info-modal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px dashed #93c5fd;
    font-size: 0.8rem;
    color: #6b7280;
}
.archivo-section-modal.has-file .archivo-info-modal {
    border-top-color: #6ee7b7;
}
.archivo-warning-modal {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #d97706;
    font-size: 0.85rem;
}
.btn-cambiar-modal {
    background: transparent;
    border: 1px solid #6b7280;
    color: #6b7280;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-cambiar-modal:hover {
    background: #f3f4f6;
    border-color: #374151;
    color: #374151;
}

/* === MODAL SUBIR ARCHIVO === */
.upload-area-modal {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    background: #f9fafb;
}
.upload-area-modal:hover,
.upload-area-modal.dragover {
    border-color: #3b82f6;
    background: #eff6ff;
}
.upload-area-modal.has-file {
    border-color: #10b981;
    background: #d1fae5;
}
.upload-area-modal input[type="file"] {
    display: none;
}
.upload-placeholder i {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 1rem;
}
.upload-placeholder p {
    color: #6b7280;
    margin: 0.5rem 0;
}
.upload-selected {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}
.upload-selected i {
    font-size: 2rem;
    color: #10b981;
}
.upload-selected .file-name {
    font-weight: 600;
    color: #065f46;
}
</style>
{% endblock %}

{% block content %}
<div class="papeletas-page">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title">
            <span class="icon"><i class="fas fa-file-alt"></i></span>
            <div>
                <h1>Consulta de Papeletas</h1>
                <p>Selecciona una tarjeta para ver sus movimientos.</p>
            </div>
        </div>
        <a href="{{ url_for('main.nueva_papeleta_form') }}" class="btn-primary"><i class="fas fa-plus"></i> Nueva Papeleta</a>
    </div>

    <!-- Selector de Tarjetas -->
    <div class="tarjetas-selector">
        {% for tarjeta, papeletas in papeletas_por_tarjeta.items() %}
        <div class="tarjeta-card {% if loop.first %}active{% endif %}" 
             data-tarjeta="{{ tarjeta.numero }}"
             onclick="seleccionarTarjeta(this, '{{ tarjeta.numero }}')">
            <div class="tarjeta-chip">
                <span class="chip-brand">VISA</span>
            </div>
            <div class="tarjeta-info">
                <span class="tarjeta-nombre">{{ tarjeta.nombre or 'Tarjeta ' + tarjeta.numero }}</span>
                <span class="tarjeta-numero">**** {{ tarjeta.numero }}</span>
            </div>
            {% if loop.first %}<span class="check-icon"><i class="fas fa-check"></i></span>{% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Filtros y Acciones -->
    <!-- Filtros y Acciones -->
    <div class="filtros-section">
        <div class="filtros-card">
            <div class="filtros-row">
                <div class="filtro-group">
                    <label><i class="fas fa-calendar-alt"></i> Desde</label>
                    <div class="input-wrapper date-wrapper">
                        <input type="text" id="fechaDesde" placeholder="Seleccionar..." readonly>
                        <i class="fas fa-calendar-alt calendar-icon"></i>
                    </div>
                </div>
                <div class="filtro-group">
                    <label><i class="fas fa-calendar-alt"></i> Hasta</label>
                    <div class="input-wrapper date-wrapper">
                        <input type="text" id="fechaHasta" placeholder="Seleccionar..." readonly>
                        <i class="fas fa-calendar-alt calendar-icon"></i>
                    </div>
                </div>
                <div class="filtro-group filtro-buscar">
                    <label><i class="fas fa-search"></i> Buscar</label>
                    <div class="input-wrapper search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="buscarTexto" placeholder="Folio, cliente, proveedor..." onkeyup="filtrarPorTexto()">
                    </div>
                </div>
                <div class="filtro-group">
                    <label><i class="fas fa-filter"></i> Estatus</label>
                    <div class="input-wrapper">
                        <select id="filtroFactura" onchange="filtrarTabla()">
                            <option value="">Todas</option>
                            <option value="facturada">Facturadas</option>
                            <option value="pendiente">Sin facturar</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filtro-actions">
                <button type="button" class="btn-limpiar" onclick="limpiarFiltros()">
                    <i class="fas fa-redo-alt"></i> Limpiar
                </button>
                <button type="button" class="btn-imprimir" onclick="abrirModalImprimir()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- Tablas por Tarjeta -->
    {% for tarjeta, papeletas in papeletas_por_tarjeta.items() %}
    <div class="tabla-tarjeta {% if loop.first %}active{% endif %}" data-tarjeta="{{ tarjeta.numero }}">
        <div class="tabla-header">
            <h3><i class="fas fa-list"></i> Movimientos: <span class="tarjeta-ref">{{ tarjeta.nombre or tarjeta.numero }}</span></h3>
            <span class="contador-registros">Mostrando <span class="count">{{ papeletas|length }}</span> registro(s)</span>
        </div>
        
        <div class="table-responsive">
            <table class="papeletas-table">
                <thead>
                    <tr>
                        <th>FOLIO</th>
                        <th>FECHA</th>
                        <th>CLIENTE / FACTURAR A</th>
                        <th>PROVEEDOR</th>
                        <th>MONTO</th>
                        <th>ESTATUS</th>
                        <th>FACTURA</th>
                        <th class="no-print">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for papeleta in papeletas %}
                    <tr data-fecha="{{ papeleta.fecha_venta.strftime('%Y-%m-%d') if papeleta.fecha_venta else '' }}"
                        data-folio="{{ papeleta.folio }}"
                        data-cliente="{{ papeleta.facturar_a|lower if papeleta.facturar_a else '' }}"
                        data-proveedor="{{ papeleta.aerolinea.nombre|lower if papeleta.aerolinea else '' }}"
                        data-factura="{{ 'facturada' if papeleta.numero_factura else 'pendiente' }}">
                        <td class="folio-cell">{{ papeleta.folio }}</td>
                        <td>{{ papeleta.fecha_venta.strftime('%d/%m/%Y') if papeleta.fecha_venta else '---' }}</td>
                        <td>{{ papeleta.facturar_a or '---' }}</td>
                        <td>
                            {% if papeleta.aerolinea %}
                            <span class="proveedor-badge">
                                <i class="fas fa-plane"></i> {{ papeleta.aerolinea.nombre }}
                            </span>
                            {% else %}
                            <span class="text-muted">---</span>
                            {% endif %}
                        </td>
                        <td class="monto-cell">${{ "{:,.2f}".format(papeleta.total) }}</td>
                        <td class="estatus-cell">
                            {% if papeleta.numero_factura and papeleta.numero_factura|upper != 'N/A' %}
                            <span class="badge-facturada" title="Facturada: {{ papeleta.numero_factura }}">
                                <i class="fas fa-check-circle"></i> Facturada
                            </span>
                            {% elif papeleta.reporte_venta_id or papeleta.numero_factura|upper == 'N/A' %}
                            <span class="badge-reportada" title="{% if papeleta.reporte_venta %}En reporte {{ papeleta.reporte_venta.folio }}{% else %}Mostrador - N/A{% endif %}">
                                <i class="fas fa-chart-bar"></i> Reportada
                            </span>
                            {% else %}
                            <span class="badge-sin-reportar" title="Sin reportar">
                                <i class="fas fa-minus-circle"></i> Pendiente
                            </span>
                            {% endif %}
                        </td>
                        <td class="factura-cell">
                            {% if papeleta.numero_factura %}
                            <span class="badge-facturada" title="Facturada"><i class="fas fa-file-invoice"></i> {{ papeleta.numero_factura }}</span>
                            {% else %}
                            <span class="badge-pendiente" title="Sin facturar"><i class="fas fa-clock"></i> Pendiente</span>
                            {% endif %}
                            {% if current_user.es_admin() %}
                            <button type="button" class="btn-factura" title="Editar factura" onclick="editarFactura({{ papeleta.id }}, '{{ papeleta.folio }}', '{{ papeleta.numero_factura or '' }}')"><i class="fas fa-edit"></i></button>
                            {% endif %}
                        </td>
                        <td class="acciones-cell no-print">
                            <button type="button" class="btn-action btn-view" title="Ver detalle" 
                                    onclick="verPapeleta({{ papeleta.id }})"><i class="fas fa-eye"></i></button>
                            <button type="button" class="btn-action btn-print" title="Imprimir ticket"
                                    onclick="imprimirTicket({{ papeleta.id }})"><i class="fas fa-print"></i></button>
                            {% if current_user.es_admin() %}
                            <button type="button" class="btn-action btn-edit" title="Editar factura"
                                    onclick="editarFactura({{ papeleta.id }}, '{{ papeleta.folio }}', '{{ papeleta.numero_factura or '' }}')"><i class="fas fa-edit"></i></button>
                            <button type="button" class="btn-action btn-delete" title="Eliminar"
                                    onclick="confirmarEliminar({{ papeleta.id }}, '{{ papeleta.folio }}')"><i class="fas fa-trash"></i></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="empty-row">No hay papeletas registradas para esta tarjeta.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" class="text-right"><strong>TOTAL:</strong></td>
                        <td class="monto-cell"><strong>${{ "{:,.2f}".format(papeletas|sum(attribute='total')) }}</strong></td>
                        <td></td>
                        <td></td>
                        <td class="no-print"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal Imprimir -->
<div class="modal-overlay" id="modalImprimir">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3><i class="fas fa-print"></i> Imprimir Reporte</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalImprimir')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="print-options">
                <h4>Tarjeta seleccionada:</h4>
                <p id="printTarjetaInfo" class="tarjeta-selected">---</p>
                
                <h4>Rango de fechas:</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Desde:</label>
                        <input type="date" id="printFechaDesde">
                    </div>
                    <div class="form-group">
                        <label>Hasta:</label>
                        <input type="date" id="printFechaHasta">
                    </div>
                </div>
                
                <div class="print-preview">
                    <p><i class="fas fa-chart-bar"></i> Registros a imprimir: <strong id="printCount">0</strong></p>
                    <p><i class="fas fa-dollar-sign"></i> Total: <strong id="printTotal">$0.00</strong></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModal('modalImprimir')">Cancelar</button>
            <button type="button" class="btn-primary" onclick="imprimirReporte()"><i class="fas fa-print"></i> Imprimir</button>
        </div>
    </div>
</div>

<!-- Modal Ver Papeleta -->
<div class="modal-overlay" id="modalVer">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Detalle de Papeleta</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalVer')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modalVerContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Cargando...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal-overlay" id="modalEliminar">
    <div class="modal-content modal-sm">
        <div class="modal-header modal-header-danger">
            <h3><i class="fas fa-trash"></i> Eliminar Papeleta</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalEliminar')"><i class="fas fa-times"></i></button>
        </div>
        <form action="" method="POST" id="formEliminar">
            <div class="modal-body">
                <p class="confirm-message">¿Estás seguro de eliminar la papeleta <strong id="eliminarFolio"></strong>?</p>
                <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
                
                <div class="form-group">
                    <label>Tipo de motivo: *</label>
                    <select name="motivo_eliminacion_tipo" required>
                        <option value="">Seleccione...</option>
                        <option value="error_captura">Error de captura</option>
                        <option value="duplicado">Registro duplicado</option>
                        <option value="cancelacion">Cancelación de servicio</option>
                        <option value="correccion">Corrección de datos</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Detalle del motivo: *</label>
                    <textarea name="motivo_eliminacion_detalle" rows="3" required minlength="10"
                              placeholder="Explique el motivo de la eliminación (mínimo 10 caracteres)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModal('modalEliminar')">Cancelar</button>
                <button type="submit" class="btn-danger"><i class="fas fa-trash"></i> Eliminar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Factura -->
<div class="modal-overlay" id="modalFactura">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3><i class="fas fa-file-invoice"></i> Asignar Número de Factura</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalFactura')"><i class="fas fa-times"></i></button>
        </div>
        <form id="formFactura" onsubmit="guardarFactura(event)">
            <div class="modal-body">
                <p>Papeleta: <strong id="facturaFolio"></strong></p>
                <input type="hidden" id="facturaPapeletaId">
                <div class="form-group">
                    <label for="numeroFactura">Número de Factura:</label>
                    <input type="text" id="numeroFactura" name="numero_factura" placeholder="Ej: FA-001234, UUID..." maxlength="50">
                    <small>Dejar vacío para quitar la factura asignada</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModal('modalFactura')">Cancelar</button>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Subir Archivo -->
<div class="modal-overlay" id="modalArchivo">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3><i class="fas fa-file-pdf"></i> Subir Comprobante PDF</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalArchivo')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p>Papeleta: <strong id="archivoFolio"></strong></p>
            <input type="hidden" id="archivoPapeletaId">
            
            <div class="upload-area-modal" id="uploadAreaModal" onclick="document.getElementById('archivoInputModal').click()">
                <input type="file" id="archivoInputModal" accept=".pdf">
                <div class="upload-placeholder" id="uploadPlaceholder">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p><strong>Haz clic o arrastra</strong> un archivo PDF</p>
                    <p style="font-size: 0.8rem; color: #9ca3af;">Máximo 10MB</p>
                </div>
                <div class="upload-selected" id="uploadSelected">
                    <i class="fas fa-file-pdf"></i>
                    <span class="file-name" id="archivoNombreModal">archivo.pdf</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModal('modalArchivo')">Cancelar</button>
            <button type="button" class="btn-primary" id="btnGuardarArchivo" onclick="guardarArchivo()" disabled>
                <i class="fas fa-upload"></i> Subir Archivo
            </button>
        </div>
    </div>
</div>

<script>

function seleccionarTarjeta(element, tarjeta) {
    document.querySelectorAll('.tarjeta-card').forEach(card => {
        card.classList.remove('active');
        card.querySelector('.check-icon')?.remove();
    });
    
    element.classList.add('active');
    const checkIcon = document.createElement('span');
    checkIcon.className = 'check-icon';
    checkIcon.innerHTML = '<i class="fas fa-check"></i>';
    element.appendChild(checkIcon);
    
    document.querySelectorAll('.tabla-tarjeta').forEach(tabla => { tabla.classList.remove('active'); });
    document.querySelector(`.tabla-tarjeta[data-tarjeta="${tarjeta}"]`).classList.add('active');
    
    tarjetaActiva = tarjeta;
    limpiarFiltros();
}

function filtrarPorFecha() { filtrarTabla(); }
function filtrarPorTexto() { filtrarTabla(); }

function filtrarTabla() {
    const desde = document.getElementById('fechaDesde').value;
    const hasta = document.getElementById('fechaHasta').value;
    const texto = document.getElementById('buscarTexto').value.toLowerCase();
    const filtroFactura = document.getElementById('filtroFactura').value;
    
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (!tablaActiva) return;
    
    const filas = tablaActiva.querySelectorAll('tbody tr[data-fecha]');
    let visibles = 0;
    let total = 0;
    
    filas.forEach(fila => {
        const fecha = fila.dataset.fecha;
        const folio = fila.dataset.folio.toLowerCase();
        const cliente = fila.dataset.cliente || '';
        const proveedor = fila.dataset.proveedor || '';
        const factura = fila.dataset.factura || '';
        
        let mostrar = true;
        if (desde && fecha < desde) mostrar = false;
        if (hasta && fecha > hasta) mostrar = false;
        if (texto && !folio.includes(texto) && !cliente.includes(texto) && !proveedor.includes(texto)) mostrar = false;
        if (filtroFactura && factura !== filtroFactura) mostrar = false;
        
        fila.style.display = mostrar ? '' : 'none';
        
        if (mostrar) {
            visibles++;
            const montoText = fila.querySelector('.monto-cell').textContent;
            total += parseFloat(montoText.replace(/[$,]/g, '')) || 0;
        }
    });
    
    tablaActiva.querySelector('.count').textContent = visibles;
    const tfoot = tablaActiva.querySelector('tfoot .monto-cell strong');
    if (tfoot) tfoot.textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function limpiarFiltros() {
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    document.getElementById('buscarTexto').value = '';
    document.getElementById('filtroFactura').value = '';
    
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (tablaActiva) {
        const filas = tablaActiva.querySelectorAll('tbody tr');
        let total = 0, count = 0;
        filas.forEach(fila => {
            fila.style.display = '';
            if (fila.dataset.fecha) {
                count++;
                const montoText = fila.querySelector('.monto-cell')?.textContent || '0';
                total += parseFloat(montoText.replace(/[$,]/g, '')) || 0;
            }
        });
        tablaActiva.querySelector('.count').textContent = count;
        const tfoot = tablaActiva.querySelector('tfoot .monto-cell strong');
        if (tfoot) tfoot.textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
}

function abrirModal(id) { document.getElementById(id).classList.add('active'); }
function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

function abrirModalImprimir() {
    const tarjetaCard = document.querySelector('.tarjeta-card.active');
    const tarjetaNombre = tarjetaCard?.querySelector('.tarjeta-nombre')?.textContent || 'Tarjeta';
    const tarjetaNumero = tarjetaCard?.querySelector('.tarjeta-numero')?.textContent || '';
    
    document.getElementById('printTarjetaInfo').textContent = `${tarjetaNombre} (${tarjetaNumero})`;
    document.getElementById('printFechaDesde').value = document.getElementById('fechaDesde').value;
    document.getElementById('printFechaHasta').value = document.getElementById('fechaHasta').value;
    
    actualizarPreviewImprimir();
    abrirModal('modalImprimir');
}

function actualizarPreviewImprimir() {
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (!tablaActiva) return;
    
    const desde = document.getElementById('printFechaDesde').value;
    const hasta = document.getElementById('printFechaHasta').value;
    const filas = tablaActiva.querySelectorAll('tbody tr[data-fecha]');
    let count = 0, total = 0;
    
    filas.forEach(fila => {
        const fecha = fila.dataset.fecha;
        let incluir = true;
        if (desde && fecha < desde) incluir = false;
        if (hasta && fecha > hasta) incluir = false;
        if (incluir) {
            count++;
            const montoText = fila.querySelector('.monto-cell').textContent;
            total += parseFloat(montoText.replace(/[$,]/g, '')) || 0;
        }
    });
    
    document.getElementById('printCount').textContent = count;
    document.getElementById('printTotal').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('printFechaDesde')?.addEventListener('change', actualizarPreviewImprimir);
    document.getElementById('printFechaHasta')?.addEventListener('change', actualizarPreviewImprimir);
});

function imprimirReporte() {
    const desde = document.getElementById('printFechaDesde').value;
    const hasta = document.getElementById('printFechaHasta').value;
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (!tablaActiva) return;
    
    const filas = tablaActiva.querySelectorAll('tbody tr[data-fecha]');
    filas.forEach(fila => {
        const fecha = fila.dataset.fecha;
        let incluir = true;
        if (desde && fecha < desde) incluir = false;
        if (hasta && fecha > hasta) incluir = false;
        fila.classList.toggle('print-hide', !incluir);
    });
    
    cerrarModal('modalImprimir');
    
    const tarjetaInfo = document.getElementById('printTarjetaInfo').textContent;
    const fechaRango = (desde || hasta) ? `Del ${formatearFecha(desde) || 'inicio'} al ${formatearFecha(hasta) || 'hoy'}` : 'Todos los registros';
    
    const printHeader = document.createElement('div');
    printHeader.id = 'printHeader';
    printHeader.className = 'print-only';
    printHeader.innerHTML = `
        <div class="print-header-content">
            <img src="{{ url_for('static', filename='img/logo_kinessia.png') }}" alt="Kinessia" class="print-logo">
            <h1>Reporte de Papeletas</h1>
            <div class="print-info">
                <p><strong>Tarjeta:</strong> ${tarjetaInfo}</p>
                <p><strong>Período:</strong> ${fechaRango}</p>
                <p><strong>Fecha de impresión:</strong> ${new Date().toLocaleDateString('es-MX', {day: '2-digit', month: '2-digit', year: 'numeric'})}</p>
            </div>
        </div>
    `;
    document.body.insertBefore(printHeader, document.body.firstChild);
    
    setTimeout(() => {
        window.print();
        setTimeout(() => {
            document.getElementById('printHeader')?.remove();
            filas.forEach(fila => fila.classList.remove('print-hide'));
        }, 500);
    }, 100);
}

function formatearFecha(fecha) {
    if (!fecha) return '';
    const [year, month, day] = fecha.split('-');
    return `${day}/${month}/${year}`;
}

function verPapeleta(id) {
    abrirModal('modalVer');
    document.getElementById('modalVerContent').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Cargando...</p></div>';
    
    fetch(`/api/papeleta/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('modalVerContent').innerHTML = `<p class="error"><i class="fas fa-exclamation-circle"></i> ${data.error}</p>`;
                return;
            }
            
            // Construir secciones opcionales
            let seccionExtemporanea = '';
            if (data.extemporanea) {
                seccionExtemporanea = `
                    <div class="detail-section extemporanea-section">
                        <h4><i class="fas fa-clock"></i> Papeleta Extemporánea</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-calendar-alt"></i> Fecha Cargo Real</span>
                                <span class="value">${data.fecha_cargo_real || '---'}</span>
                            </div>
                            <div class="detail-item full-width">
                                <span class="label"><i class="fas fa-comment"></i> Motivo Tardío</span>
                                <span class="value">${data.motivo_extemporanea || '---'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            let seccionReembolso = '';
            if (data.tiene_reembolso) {
                seccionReembolso = `
                    <div class="detail-section reembolso-section">
                        <h4><i class="fas fa-undo"></i> Información de Reembolso</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-tag"></i> Motivo</span>
                                <span class="value">${data.motivo_reembolso || '---'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-dollar-sign"></i> Monto</span>
                                <span class="value">${data.monto_reembolso ? '$' + Number(data.monto_reembolso).toLocaleString('en-US', {minimumFractionDigits: 2}) : '---'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-info-circle"></i> Estatus</span>
                                <span class="value badge-estatus-${data.estatus_reembolso || 'pendiente'}">${data.estatus_reembolso || 'pendiente'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-calendar"></i> Fecha Solicitud</span>
                                <span class="value">${data.fecha_solicitud_reembolso || '---'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-file-alt"></i> Referencia/Caso</span>
                                <span class="value">${data.referencia_reembolso || '---'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-link"></i> Papeleta Relacionada</span>
                                <span class="value">${data.papeleta_relacionada || '---'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ====== NUEVA SECCIÓN: Reporte de Ventas ======
            let seccionReporte = '';
            if (data.esta_reportada && data.reporte_folio) {
                seccionReporte = `
                    <div class="detail-section reporte-info">
                        <h4><i class="fas fa-chart-bar"></i> Reporte de Ventas</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-hashtag"></i> Folio Reporte</span>
                                <span class="value"><strong>${data.reporte_folio}</strong></span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-calendar"></i> Fecha Reporte</span>
                                <span class="value">${data.reporte_fecha || '---'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label"><i class="fas fa-info-circle"></i> Estatus</span>
                                <span class="value" style="text-transform: capitalize;">${data.reporte_estatus || '---'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <a href="/reportes-ventas/${data.reporte_venta_id}/ver" class="reporte-link">
                                <i class="fas fa-external-link-alt"></i> Ver Reporte Completo
                            </a>
                        </div>
                    </div>
                `;
            }
            // =============================================
            
            // ====== SECCIÓN: Archivo PDF / Boleto ======
            let seccionArchivo = '';
            if (data.archivo_boleto) {
                seccionArchivo = `
                    <div class="archivo-section-modal has-file">
                        <h4><i class="fas fa-file-pdf"></i> Comprobante / Boleto PDF</h4>
                        <div class="archivo-actions-modal">
                            <a href="/static/uploads/boletos/${data.archivo_boleto}" target="_blank" class="btn-archivo-modal btn-ver-pdf-modal">
                                <i class="fas fa-eye"></i> Ver PDF
                            </a>
                            <a href="/static/uploads/boletos/${data.archivo_boleto}" download class="btn-archivo-modal btn-descargar-modal">
                                <i class="fas fa-download"></i> Descargar
                            </a>
                        </div>
                        <div class="archivo-info-modal">
                            <small><i class="fas fa-paperclip"></i> ${data.archivo_boleto}</small>
                            <button type="button" class="btn-cambiar-modal" onclick="abrirModalArchivo(${data.id}, '${data.folio}')">
                                <i class="fas fa-sync-alt"></i> Cambiar
                            </button>
                        </div>
                    </div>
                `;
            } else {
                seccionArchivo = `
                    <div class="archivo-section-modal">
                        <h4><i class="fas fa-file-pdf"></i> Comprobante / Boleto PDF</h4>
                        <div class="archivo-warning-modal">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>No hay archivo adjunto</span>
                        </div>
                        <button type="button" class="btn-archivo-modal btn-subir-modal" style="margin-top: 0.75rem;" onclick="abrirModalArchivo(${data.id}, '${data.folio}')">
                            <i class="fas fa-upload"></i> Subir PDF
                        </button>
                    </div>
                `;
            }
            // =============================================
            
            document.getElementById('modalVerContent').innerHTML = `
                <div class="papeleta-detail">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-hashtag"></i> Folio</span>
                            <span class="value">${data.folio}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-credit-card"></i> Tarjeta</span>
                            <span class="value">${data.tarjeta_nombre || '**** ' + data.tarjeta}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-calendar"></i> Fecha Venta</span>
                            <span class="value">${data.fecha_venta}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-building"></i> Facturar a</span>
                            <span class="value">${data.facturar_a || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-user"></i> Solicitó</span>
                            <span class="value">${data.solicito || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-plane"></i> Aerolínea/Proveedor</span>
                            <span class="value">${data.aerolinea || data.proveedor || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-map-marker-alt"></i> Sucursal</span>
                            <span class="value">${data.sucursal || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-key"></i> Clave Sabre</span>
                            <span class="value">${data.clave_sabre || '---'}</span>
                        </div>
                    </div>
                    
                    ${data.extemporanea ? '<span class="badge-extemporanea"><i class="fas fa-clock"></i> Extemporánea</span>' : ''}
                    ${data.tiene_reembolso ? '<span class="badge-reembolso"><i class="fas fa-undo"></i> Con Reembolso</span>' : ''}
                    
                    <div class="detail-section montos">
                        <h4><i class="fas fa-dollar-sign"></i> Desglose de Montos</h4>
                        <div class="montos-grid">
                            <div class="monto-item">
                                <span class="label">Total Ticket</span>
                                <span class="value">$${Number(data.total_ticket).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="monto-item">
                                <span class="label">10%</span>
                                <span class="value">$${Number(data.diez_porciento).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="monto-item">
                                <span class="label">Cargo Visible</span>
                                <span class="value">$${Number(data.cargo).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            ${data.cargo_oculto > 0 ? `
                            <div class="monto-item oculto">
                                <span class="label"><i class="fas fa-eye-slash"></i> Cargo Oculto</span>
                                <span class="value">$${Number(data.cargo_oculto).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            ` : ''}
                            <div class="monto-item total">
                                <span class="label">TOTAL</span>
                                <span class="value">$${Number(data.total).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${seccionExtemporanea}
                    ${seccionReembolso}
                    ${seccionReporte}
                    ${seccionArchivo}
                    
                    <div class="detail-footer">
                        <small>Creado por: ${data.usuario} | ${data.created_at}</small>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('modalVerContent').innerHTML = `<p class="error"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</p>`;
        });
}

function confirmarEliminar(id, folio) {
    document.getElementById('eliminarFolio').textContent = folio;
    document.getElementById('formEliminar').action = `/papeletas/eliminar/${id}`;
    abrirModal('modalEliminar');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => { modal.classList.remove('active'); });
    }
});

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); });
});

// === FACTURA ===
function editarFactura(id, folio, numeroActual) {
    document.getElementById('facturaPapeletaId').value = id;
    document.getElementById('facturaFolio').textContent = folio;
    document.getElementById('numeroFactura').value = numeroActual || '';
    abrirModal('modalFactura');
}

function guardarFactura(e) {
    e.preventDefault();
    const id = document.getElementById('facturaPapeletaId').value;
    const numero = document.getElementById('numeroFactura').value.trim();
    
    fetch(`/api/papeleta/${id}/factura`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero_factura: numero })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cerrarModal('modalFactura');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'No se pudo guardar'));
        }
    })
    .catch(error => {
        alert('Error de conexión: ' + error.message);
    });
}

// === IMPRESIÓN DE TICKET ===
function imprimirTicket(papeletaId) {
    window.open(`/papeleta/${papeletaId}/ticket`, '_blank', 'width=350,height=550,scrollbars=yes');
}

// === ARCHIVO PDF ===
let archivoIdActual = null;

function abrirModalArchivo(id, folio) {
    archivoIdActual = id;
    document.getElementById('archivoPapeletaId').value = id;
    document.getElementById('archivoFolio').textContent = folio;
    limpiarArchivoModal();
    abrirModal('modalArchivo');
}

function limpiarArchivoModal() {
    const input = document.getElementById('archivoInputModal');
    input.value = '';
    document.getElementById('uploadPlaceholder').style.display = 'block';
    document.getElementById('uploadSelected').style.display = 'none';
    document.getElementById('uploadAreaModal').classList.remove('has-file');
    document.getElementById('btnGuardarArchivo').disabled = true;
}

// Manejo del input de archivo
document.getElementById('archivoInputModal').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Solo se permiten archivos PDF');
            limpiarArchivoModal();
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('El archivo es muy grande. Máximo 10MB.');
            limpiarArchivoModal();
            return;
        }
        
        document.getElementById('archivoNombreModal').textContent = file.name;
        document.getElementById('uploadPlaceholder').style.display = 'none';
        document.getElementById('uploadSelected').style.display = 'flex';
        document.getElementById('uploadAreaModal').classList.add('has-file');
        document.getElementById('btnGuardarArchivo').disabled = false;
    }
});

// Drag and drop
const uploadAreaModal = document.getElementById('uploadAreaModal');

uploadAreaModal.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadAreaModal.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadAreaModal.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const input = document.getElementById('archivoInputModal');
        input.files = files;
        input.dispatchEvent(new Event('change'));
    }
});

function guardarArchivo() {
    const input = document.getElementById('archivoInputModal');
    if (!input.files || !input.files[0]) {
        alert('Selecciona un archivo PDF');
        return;
    }
    
    const formData = new FormData();
    formData.append('archivo_boleto', input.files[0]);
    
    const btn = document.getElementById('btnGuardarArchivo');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
    
    fetch(`/api/papeleta/${archivoIdActual}/archivo`, {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cerrarModal('modalArchivo');
            // Recargar el modal de detalle para mostrar el archivo
            verPapeleta(archivoIdActual);
            alert('Archivo subido correctamente');
        } else {
            alert('Error: ' + (data.error || 'No se pudo subir el archivo'));
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload"></i> Subir Archivo';
        }
    })
    .catch(err => {
        alert('Error de conexión: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload"></i> Subir Archivo';
    });
}
</script>

<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script>
// Inicializar Flatpickr en español
const fpConfig = {
    locale: 'es',
    dateFormat: 'Y-m-d',
    altInput: true,
    altFormat: 'd/m/Y',
    allowInput: false,
    disableMobile: true,
    onChange: function() {
        filtrarPorFecha();
    }
};

flatpickr('#fechaDesde', {
    ...fpConfig,
    placeholder: 'Desde...'
});

flatpickr('#fechaHasta', {
    ...fpConfig,
    placeholder: 'Hasta...'
});
</script>
{% endblock %}