{% extends "base.html" %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_consulta_papeletas.css') }}">
{% endblock %}

{% block content %}
<div class="papeletas-page">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title">
            <span class="icon"><i class="fas fa-file-alt"></i></span>
            <div>
                <h1>Consulta de Papeletas</h1>
                <p>Selecciona una tarjeta para ver sus movimientos.</p>
            </div>
        </div>
        <a href="{{ url_for('main.nueva_papeleta_form') }}" class="btn-primary"><i class="fas fa-plus"></i> Nueva Papeleta</a>
    </div>

    <!-- Selector de Tarjetas -->
    <div class="tarjetas-selector">
        {% for tarjeta, papeletas in papeletas_por_tarjeta.items() %}
        <div class="tarjeta-card {% if loop.first %}active{% endif %}" 
             data-tarjeta="{{ tarjeta.numero }}"
             onclick="seleccionarTarjeta(this, '{{ tarjeta.numero }}')">
            <div class="tarjeta-chip">
                <span class="chip-brand">VISA</span>
            </div>
            <div class="tarjeta-info">
                <span class="tarjeta-nombre">{{ tarjeta.nombre or 'Tarjeta ' + tarjeta.numero }}</span>
                <span class="tarjeta-numero">**** {{ tarjeta.numero }}</span>
            </div>
            {% if loop.first %}<span class="check-icon"><i class="fas fa-check"></i></span>{% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Filtros y Acciones -->
    <div class="filtros-section">
        <div class="filtros-row">
            <div class="filtro-group">
                <label><i class="fas fa-calendar"></i> Desde:</label>
                <input type="date" id="fechaDesde" onchange="filtrarPorFecha()">
            </div>
            <div class="filtro-group">
                <label><i class="fas fa-calendar"></i> Hasta:</label>
                <input type="date" id="fechaHasta" onchange="filtrarPorFecha()">
            </div>
            <div class="filtro-group">
                <label><i class="fas fa-search"></i> Buscar:</label>
                <input type="text" id="buscarTexto" placeholder="Folio, cliente, proveedor..." onkeyup="filtrarPorTexto()">
            </div>
            <div class="filtro-group">
                <label><i class="fas fa-file-invoice"></i> Factura:</label>
                <select id="filtroFactura" onchange="filtrarTabla()">
                    <option value="">Todas</option>
                    <option value="facturada">Facturadas</option>
                    <option value="pendiente">Sin facturar</option>
                </select>
            </div>
            <div class="filtro-actions">
                <button type="button" class="btn-secondary" onclick="limpiarFiltros()">
                    <i class="fas fa-sync"></i> Limpiar
                </button>
                <button type="button" class="btn-print" onclick="abrirModalImprimir()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- Tablas por Tarjeta -->
    {% for tarjeta, papeletas in papeletas_por_tarjeta.items() %}
    <div class="tabla-tarjeta {% if loop.first %}active{% endif %}" data-tarjeta="{{ tarjeta.numero }}">
        <div class="tabla-header">
            <h3><i class="fas fa-list"></i> Movimientos: <span class="tarjeta-ref">{{ tarjeta.nombre or tarjeta.numero }}</span></h3>
            <span class="contador-registros">Mostrando <span class="count">{{ papeletas|length }}</span> registro(s)</span>
        </div>
        
        <div class="table-responsive">
            <table class="papeletas-table">
                <thead>
                    <tr>
                        <th>FOLIO</th>
                        <th>FECHA</th>
                        <th>CLIENTE / FACTURAR A</th>
                        <th>PROVEEDOR</th>
                        <th>MONTO</th>
                        <th>FACTURA</th>
                        <th class="no-print">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for papeleta in papeletas %}
                    <tr data-fecha="{{ papeleta.fecha_venta.strftime('%Y-%m-%d') if papeleta.fecha_venta else '' }}"
                        data-folio="{{ papeleta.folio }}"
                        data-cliente="{{ papeleta.facturar_a|lower if papeleta.facturar_a else '' }}"
                        data-proveedor="{{ papeleta.aerolinea.nombre|lower if papeleta.aerolinea else '' }}"
                        data-factura="{{ 'facturada' if papeleta.numero_factura else 'pendiente' }}">
                        <td class="folio-cell">{{ papeleta.folio }}</td>
                        <td>{{ papeleta.fecha_venta.strftime('%d/%m/%Y') if papeleta.fecha_venta else '---' }}</td>
                        <td>{{ papeleta.facturar_a or '---' }}</td>
                        <td>
                            {% if papeleta.aerolinea %}
                            <span class="proveedor-badge">
                                <i class="fas fa-plane"></i> {{ papeleta.aerolinea.nombre }}
                            </span>
                            {% else %}
                            <span class="text-muted">---</span>
                            {% endif %}
                        </td>
                        <td class="monto-cell">${{ "{:,.2f}".format(papeleta.total) }}</td>
                        <td class="factura-cell">
                            {% if papeleta.numero_factura %}
                            <span class="badge-facturada" title="Facturada"><i class="fas fa-file-invoice"></i> {{ papeleta.numero_factura }}</span>
                            {% else %}
                            <span class="badge-pendiente" title="Sin facturar"><i class="fas fa-clock"></i> Pendiente</span>
                            {% endif %}
                            {% if current_user.es_admin() %}
                            <button type="button" class="btn-factura" title="Editar factura" onclick="editarFactura({{ papeleta.id }}, '{{ papeleta.folio }}', '{{ papeleta.numero_factura or '' }}')"><i class="fas fa-edit"></i></button>
                            {% endif %}
                        </td>
                        <td class="acciones-cell no-print">
                            <button type="button" class="btn-action btn-view" title="Ver detalle" 
                                    onclick="verPapeleta({{ papeleta.id }})"><i class="fas fa-eye"></i></button>
                            {% if current_user.es_admin() %}
                            <button type="button" class="btn-action btn-edit" title="Editar"
                                    onclick="window.location.href='{{ url_for('main.editar_papeleta', id=papeleta.id) }}'"><i class="fas fa-edit"></i></button>
                            <button type="button" class="btn-action btn-delete" title="Eliminar"
                                    onclick="confirmarEliminar({{ papeleta.id }}, '{{ papeleta.folio }}')"><i class="fas fa-trash"></i></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="empty-row">No hay papeletas registradas para esta tarjeta.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5" class="text-right"><strong>TOTAL:</strong></td>
                        <td class="monto-cell"><strong>${{ "{:,.2f}".format(papeletas|sum(attribute='total')) }}</strong></td>
                        <td class="no-print"></td>
                        <td class="no-print"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal Imprimir -->
<div class="modal-overlay" id="modalImprimir">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3><i class="fas fa-print"></i> Imprimir Reporte</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalImprimir')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="print-options">
                <h4>Tarjeta seleccionada:</h4>
                <p id="printTarjetaInfo" class="tarjeta-selected">---</p>
                
                <h4>Rango de fechas:</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Desde:</label>
                        <input type="date" id="printFechaDesde">
                    </div>
                    <div class="form-group">
                        <label>Hasta:</label>
                        <input type="date" id="printFechaHasta">
                    </div>
                </div>
                
                <div class="print-preview">
                    <p><i class="fas fa-chart-bar"></i> Registros a imprimir: <strong id="printCount">0</strong></p>
                    <p><i class="fas fa-dollar-sign"></i> Total: <strong id="printTotal">$0.00</strong></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModal('modalImprimir')">Cancelar</button>
            <button type="button" class="btn-primary" onclick="imprimirReporte()"><i class="fas fa-print"></i> Imprimir</button>
        </div>
    </div>
</div>

<!-- Modal Ver Papeleta -->
<div class="modal-overlay" id="modalVer">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Detalle de Papeleta</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalVer')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modalVerContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Cargando...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal-overlay" id="modalEliminar">
    <div class="modal-content modal-sm">
        <div class="modal-header modal-header-danger">
            <h3><i class="fas fa-trash"></i> Eliminar Papeleta</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalEliminar')"><i class="fas fa-times"></i></button>
        </div>
        <form action="" method="POST" id="formEliminar">
            <div class="modal-body">
                <p class="confirm-message">¿Estás seguro de eliminar la papeleta <strong id="eliminarFolio"></strong>?</p>
                <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
                
                <div class="form-group">
                    <label>Tipo de motivo: *</label>
                    <select name="motivo_eliminacion_tipo" required>
                        <option value="">Seleccione...</option>
                        <option value="error_captura">Error de captura</option>
                        <option value="duplicado">Registro duplicado</option>
                        <option value="cancelacion">Cancelación de servicio</option>
                        <option value="correccion">Corrección de datos</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Detalle del motivo: *</label>
                    <textarea name="motivo_eliminacion_detalle" rows="3" required minlength="10"
                              placeholder="Explique el motivo de la eliminación (mínimo 10 caracteres)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModal('modalEliminar')">Cancelar</button>
                <button type="submit" class="btn-danger"><i class="fas fa-trash"></i> Eliminar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Factura -->
<div class="modal-overlay" id="modalFactura">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3><i class="fas fa-file-invoice"></i> Asignar Número de Factura</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalFactura')"><i class="fas fa-times"></i></button>
        </div>
        <form id="formFactura" onsubmit="guardarFactura(event)">
            <div class="modal-body">
                <p>Papeleta: <strong id="facturaFolio"></strong></p>
                <input type="hidden" id="facturaPapeletaId">
                <div class="form-group">
                    <label for="numeroFactura">Número de Factura:</label>
                    <input type="text" id="numeroFactura" name="numero_factura" placeholder="Ej: FA-001234, UUID..." maxlength="50">
                    <small>Dejar vacío para quitar la factura asignada</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModal('modalFactura')">Cancelar</button>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
let tarjetaActiva = '';

function seleccionarTarjeta(element, tarjeta) {
    document.querySelectorAll('.tarjeta-card').forEach(card => {
        card.classList.remove('active');
        card.querySelector('.check-icon')?.remove();
    });
    
    element.classList.add('active');
    const checkIcon = document.createElement('span');
    checkIcon.className = 'check-icon';
    checkIcon.innerHTML = '<i class="fas fa-check"></i>';
    element.appendChild(checkIcon);
    
    document.querySelectorAll('.tabla-tarjeta').forEach(tabla => { tabla.classList.remove('active'); });
    document.querySelector(`.tabla-tarjeta[data-tarjeta="${tarjeta}"]`).classList.add('active');
    
    tarjetaActiva = tarjeta;
    limpiarFiltros();
}

function filtrarPorFecha() { filtrarTabla(); }
function filtrarPorTexto() { filtrarTabla(); }

function filtrarTabla() {
    const desde = document.getElementById('fechaDesde').value;
    const hasta = document.getElementById('fechaHasta').value;
    const texto = document.getElementById('buscarTexto').value.toLowerCase();
    const filtroFactura = document.getElementById('filtroFactura').value;
    
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (!tablaActiva) return;
    
    const filas = tablaActiva.querySelectorAll('tbody tr[data-fecha]');
    let visibles = 0;
    let total = 0;
    
    filas.forEach(fila => {
        const fecha = fila.dataset.fecha;
        const folio = fila.dataset.folio.toLowerCase();
        const cliente = fila.dataset.cliente || '';
        const proveedor = fila.dataset.proveedor || '';
        const factura = fila.dataset.factura || '';
        
        let mostrar = true;
        if (desde && fecha < desde) mostrar = false;
        if (hasta && fecha > hasta) mostrar = false;
        if (texto && !folio.includes(texto) && !cliente.includes(texto) && !proveedor.includes(texto)) mostrar = false;
        if (filtroFactura && factura !== filtroFactura) mostrar = false;
        
        fila.style.display = mostrar ? '' : 'none';
        
        if (mostrar) {
            visibles++;
            const montoText = fila.querySelector('.monto-cell').textContent;
            total += parseFloat(montoText.replace(/[$,]/g, '')) || 0;
        }
    });
    
    tablaActiva.querySelector('.count').textContent = visibles;
    const tfoot = tablaActiva.querySelector('tfoot .monto-cell strong');
    if (tfoot) tfoot.textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function limpiarFiltros() {
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    document.getElementById('buscarTexto').value = '';
    document.getElementById('filtroFactura').value = '';
    
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (tablaActiva) {
        const filas = tablaActiva.querySelectorAll('tbody tr');
        let total = 0, count = 0;
        filas.forEach(fila => {
            fila.style.display = '';
            if (fila.dataset.fecha) {
                count++;
                const montoText = fila.querySelector('.monto-cell')?.textContent || '0';
                total += parseFloat(montoText.replace(/[$,]/g, '')) || 0;
            }
        });
        tablaActiva.querySelector('.count').textContent = count;
        const tfoot = tablaActiva.querySelector('tfoot .monto-cell strong');
        if (tfoot) tfoot.textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
}

function abrirModal(id) { document.getElementById(id).classList.add('active'); }
function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

function abrirModalImprimir() {
    const tarjetaCard = document.querySelector('.tarjeta-card.active');
    const tarjetaNombre = tarjetaCard?.querySelector('.tarjeta-nombre')?.textContent || 'Tarjeta';
    const tarjetaNumero = tarjetaCard?.querySelector('.tarjeta-numero')?.textContent || '';
    
    document.getElementById('printTarjetaInfo').textContent = `${tarjetaNombre} (${tarjetaNumero})`;
    document.getElementById('printFechaDesde').value = document.getElementById('fechaDesde').value;
    document.getElementById('printFechaHasta').value = document.getElementById('fechaHasta').value;
    
    actualizarPreviewImprimir();
    abrirModal('modalImprimir');
}

function actualizarPreviewImprimir() {
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (!tablaActiva) return;
    
    const desde = document.getElementById('printFechaDesde').value;
    const hasta = document.getElementById('printFechaHasta').value;
    const filas = tablaActiva.querySelectorAll('tbody tr[data-fecha]');
    let count = 0, total = 0;
    
    filas.forEach(fila => {
        const fecha = fila.dataset.fecha;
        let incluir = true;
        if (desde && fecha < desde) incluir = false;
        if (hasta && fecha > hasta) incluir = false;
        if (incluir) {
            count++;
            const montoText = fila.querySelector('.monto-cell').textContent;
            total += parseFloat(montoText.replace(/[$,]/g, '')) || 0;
        }
    });
    
    document.getElementById('printCount').textContent = count;
    document.getElementById('printTotal').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('printFechaDesde')?.addEventListener('change', actualizarPreviewImprimir);
    document.getElementById('printFechaHasta')?.addEventListener('change', actualizarPreviewImprimir);
});

function imprimirReporte() {
    const desde = document.getElementById('printFechaDesde').value;
    const hasta = document.getElementById('printFechaHasta').value;
    const tablaActiva = document.querySelector('.tabla-tarjeta.active');
    if (!tablaActiva) return;
    
    const filas = tablaActiva.querySelectorAll('tbody tr[data-fecha]');
    filas.forEach(fila => {
        const fecha = fila.dataset.fecha;
        let incluir = true;
        if (desde && fecha < desde) incluir = false;
        if (hasta && fecha > hasta) incluir = false;
        fila.classList.toggle('print-hide', !incluir);
    });
    
    cerrarModal('modalImprimir');
    
    const tarjetaInfo = document.getElementById('printTarjetaInfo').textContent;
    const fechaRango = (desde || hasta) ? `Del ${formatearFecha(desde) || 'inicio'} al ${formatearFecha(hasta) || 'hoy'}` : 'Todos los registros';
    
    const printHeader = document.createElement('div');
    printHeader.id = 'printHeader';
    printHeader.className = 'print-only';
    printHeader.innerHTML = `
        <div class="print-header-content">
            <img src="{{ url_for('static', filename='img/logo_kinessia.png') }}" alt="Kinessia" class="print-logo">
            <h1>Reporte de Papeletas</h1>
            <div class="print-info">
                <p><strong>Tarjeta:</strong> ${tarjetaInfo}</p>
                <p><strong>Período:</strong> ${fechaRango}</p>
                <p><strong>Fecha de impresión:</strong> ${new Date().toLocaleDateString('es-MX', {day: '2-digit', month: '2-digit', year: 'numeric'})}</p>
            </div>
        </div>
    `;
    document.body.insertBefore(printHeader, document.body.firstChild);
    
    setTimeout(() => {
        window.print();
        setTimeout(() => {
            document.getElementById('printHeader')?.remove();
            filas.forEach(fila => fila.classList.remove('print-hide'));
        }, 500);
    }, 100);
}

function formatearFecha(fecha) {
    if (!fecha) return '';
    const [year, month, day] = fecha.split('-');
    return `${day}/${month}/${year}`;
}

function verPapeleta(id) {
    abrirModal('modalVer');
    document.getElementById('modalVerContent').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Cargando...</p></div>';
    
    fetch(`/api/papeleta/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('modalVerContent').innerHTML = `<p class="error"><i class="fas fa-exclamation-circle"></i> ${data.error}</p>`;
                return;
            }
            
            document.getElementById('modalVerContent').innerHTML = `
                <div class="papeleta-detail">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-hashtag"></i> Folio</span>
                            <span class="value">${data.folio}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-credit-card"></i> Tarjeta</span>
                            <span class="value">${data.tarjeta_nombre || '**** ' + data.tarjeta}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-calendar"></i> Fecha Venta</span>
                            <span class="value">${data.fecha_venta}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-building"></i> Facturar a</span>
                            <span class="value">${data.facturar_a || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-user"></i> Solicitó</span>
                            <span class="value">${data.solicito || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-plane"></i> Aerolínea/Proveedor</span>
                            <span class="value">${data.aerolinea || data.proveedor || '---'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section montos">
                        <h4><i class="fas fa-dollar-sign"></i> Desglose de Montos</h4>
                        <div class="montos-grid">
                            <div class="monto-item">
                                <span class="label">Total Ticket</span>
                                <span class="value">$${Number(data.total_ticket).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="monto-item">
                                <span class="label">10%</span>
                                <span class="value">$${Number(data.diez_porciento).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="monto-item">
                                <span class="label">Cargo</span>
                                <span class="value">$${Number(data.cargo).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="monto-item total">
                                <span class="label">TOTAL</span>
                                <span class="value">$${Number(data.total).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-footer">
                        <small>Creado por: ${data.usuario} | ${data.created_at}</small>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('modalVerContent').innerHTML = `<p class="error"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</p>`;
        });
}

function confirmarEliminar(id, folio) {
    document.getElementById('eliminarFolio').textContent = folio;
    document.getElementById('formEliminar').action = `/papeletas/eliminar/${id}`;
    abrirModal('modalEliminar');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => { modal.classList.remove('active'); });
    }
});

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); });
});

// === FACTURA ===
function editarFactura(id, folio, numeroActual) {
    document.getElementById('facturaPapeletaId').value = id;
    document.getElementById('facturaFolio').textContent = folio;
    document.getElementById('numeroFactura').value = numeroActual || '';
    abrirModal('modalFactura');
}

function guardarFactura(e) {
    e.preventDefault();
    const id = document.getElementById('facturaPapeletaId').value;
    const numero = document.getElementById('numeroFactura').value.trim();
    
    fetch(`/api/papeleta/${id}/factura`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero_factura: numero })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cerrarModal('modalFactura');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'No se pudo guardar'));
        }
    })
    .catch(error => {
        alert('Error de conexión: ' + error.message);
    });
}
</script>
{% endblock %}