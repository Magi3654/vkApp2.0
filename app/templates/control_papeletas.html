{% extends "base.html" %}

{% block title %}Control de Papeletas - Kinessia Hub{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_control_papeletas.css') }}">
{% endblock %}

{% block content %}
<div class="control-container">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title">
            <span class="icon"><i class="fas fa-clipboard-check"></i></span>
            <div>
                <h1>Control de Papeletas</h1>
                <p>Verificación y seguimiento de documentos</p>
            </div>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('main.consulta_papeletas') }}" class="btn-secondary">
                <i class="fas fa-list"></i> Ver Todas
            </a>
            <a href="{{ url_for('main.nueva_papeleta_form') }}" class="btn-primary">
                <i class="fas fa-plus"></i> Nueva Papeleta
            </a>
        </div>
    </div>

    <!-- Alertas -->
    {% if sin_reportar > 0 %}
    <div class="alertas-panel">
        <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="content">
            <h3>{{ sin_reportar }} papeleta(s) sin reportar</h3>
            <p>Papeletas que no han sido incluidas en ningún reporte de ventas</p>
        </div>
        <a href="#" class="btn-ver" onclick="cambiarTab('sin_reportar')">Ver papeletas</a>
    </div>
    {% endif %}
    
    {% if sin_facturar > 0 %}
    <div class="alertas-panel warning">
        <div class="icon"><i class="fas fa-file-invoice"></i></div>
        <div class="content">
            <h3>{{ sin_facturar }} papeleta(s) pendientes de facturar</h3>
            <p>Papeletas reportadas que aún no tienen número de factura asignado</p>
        </div>
        <a href="#" class="btn-ver" onclick="cambiarTab('sin_facturar')">Ver papeletas</a>
    </div>
    {% endif %}
    
    {% if urgentes > 0 %}
    <div class="alertas-panel" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);">
        <div class="icon"><i class="fas fa-clock"></i></div>
        <div class="content">
            <h3>{{ urgentes }} papeleta(s) con más de 3 días</h3>
            <p>Papeletas antiguas que requieren atención inmediata</p>
        </div>
        <a href="#" class="btn-ver" onclick="cambiarTab('pendientes')">Ver urgentes</a>
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card info">
            <div class="icon"><i class="fas fa-file-alt"></i></div>
            <div class="value">{{ papeletas_hoy }}</div>
            <div class="label">Papeletas Hoy</div>
            <div class="monto">${{ '{:,.2f}'.format(total_hoy) }}</div>
        </div>
        
        <div class="stat-card danger">
            <div class="icon"><i class="fas fa-exclamation-circle"></i></div>
            <div class="value">{{ sin_reportar }}</div>
            <div class="label">Sin Reportar</div>
            <div class="monto" style="color: #dc2626;">${{ '{:,.2f}'.format(total_sin_reportar) }}</div>
        </div>
        
        <div class="stat-card warning">
            <div class="icon"><i class="fas fa-file-invoice"></i></div>
            <div class="value">{{ sin_facturar }}</div>
            <div class="label">Sin Facturar</div>
            <div class="monto" style="color: #d97706;">${{ '{:,.2f}'.format(total_sin_facturar) }}</div>
        </div>
        
        <div class="stat-card success">
            <div class="icon"><i class="fas fa-check-circle"></i></div>
            <div class="value">{{ facturadas }}</div>
            <div class="label">Facturadas</div>
            <div class="monto">${{ '{:,.2f}'.format(total_facturadas) }}</div>
        </div>
        
        <div class="stat-card purple">
            <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
            <div class="value">${{ '{:,.0f}'.format(efectivo_pendiente) }}</div>
            <div class="label">Efectivo Pendiente</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="todas">
                <i class="fas fa-list"></i> Todas
            </button>
            <button class="tab-btn" data-tab="sin_reportar">
                <i class="fas fa-exclamation-circle"></i> Sin Reportar
                {% if sin_reportar > 0 %}<span class="badge">{{ sin_reportar }}</span>{% endif %}
            </button>
            <button class="tab-btn" data-tab="sin_facturar">
                <i class="fas fa-file-invoice"></i> Sin Facturar
                {% if sin_facturar > 0 %}<span class="badge warning">{{ sin_facturar }}</span>{% endif %}
            </button>
            <button class="tab-btn" data-tab="facturadas">
                <i class="fas fa-check-circle"></i> Facturadas
                <span class="badge success">{{ facturadas }}</span>
            </button>
            <button class="tab-btn" data-tab="hoy">
                <i class="fas fa-calendar-day"></i> Hoy
                <span class="badge info">{{ papeletas_hoy }}</span>
            </button>
        </div>

        <!-- Tab: Todas -->
        <div class="tab-content active" id="tab-todas">
            <table class="tabla-papeletas">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Fecha</th>
                        <th>Agente</th>
                        <th>Cliente</th>
                        <th class="text-right">Total</th>
                        <th>Estatus</th>
                        <th>Reporte</th>
                        <th>Factura</th>
                        <th>Días</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in papeletas %}
                    <tr data-id="{{ p.id }}">
                        <td class="folio">{{ p.folio }}</td>
                        <td>{{ p.fecha_venta.strftime('%d/%m/%y') if p.fecha_venta else '-' }}</td>
                        <td class="agente">
                            <span class="avatar">{{ p.usuario.nombre[:2]|upper if p.usuario else '??' }}</span>
                            {{ p.usuario.nombre.split()[0] if p.usuario else '-' }}
                        </td>
                        <td>{{ p.facturar_a or (p.empresa.nombre_empresa if p.empresa else '-') }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(p.total|float) }}</td>
                        <td>
                            {% if p.numero_factura and p.numero_factura|upper != 'N/A' %}
                            <span class="badge-estado facturada"><i class="fas fa-check"></i> Facturada</span>
                            {% elif p.reporte_venta_id or p.numero_factura|upper == 'N/A' %}
                            <span class="badge-estado reportada"><i class="fas fa-chart-bar"></i> Reportada</span>
                            {% else %}
                            <span class="badge-estado sin-reportar"><i class="fas fa-times"></i> Sin reportar</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if p.reporte_venta and p.reporte_venta.folio %}
                            <a href="{{ url_for('main.ver_reporte_venta', id=p.reporte_venta_id) }}" 
                               class="folio" style="font-size: 0.8rem;">
                                {{ p.reporte_venta.folio }}
                            </a>
                            {% else %}
                            <span style="color: #9ca3af;">---</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if p.numero_factura %}
                            <span style="color: #059669; font-weight: 600;">{{ p.numero_factura }}</span>
                            {% else %}
                            <span style="color: #9ca3af;">---</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set dias = (fecha_actual - p.fecha_venta).days if p.fecha_venta else 0 %}
                            {% if dias > 3 %}
                            <span class="dias-pendiente danger">{{ dias }}d</span>
                            {% elif dias > 0 %}
                            <span class="dias-pendiente warning">{{ dias }}d</span>
                            {% else %}
                            <span class="dias-pendiente info">Hoy</span>
                            {% endif %}
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-accion btn-ver" onclick="verDetalle({{ p.id }})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if not p.numero_factura and current_user.es_admin() %}
                            <button class="btn-accion btn-factura" onclick="asignarFactura({{ p.id }}, '{{ p.folio }}')" title="Asignar factura">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            No hay papeletas para mostrar
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Tab: Sin Reportar -->
        <div class="tab-content" id="tab-sin_reportar">
            <table class="tabla-papeletas">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Fecha</th>
                        <th>Agente</th>
                        <th>Cliente</th>
                        <th class="text-right">Total</th>
                        <th>Forma Pago</th>
                        <th>Días</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in papeletas if not p.reporte_venta_id and not p.numero_factura %}
                    <tr data-id="{{ p.id }}">
                        <td class="folio">{{ p.folio }}</td>
                        <td>{{ p.fecha_venta.strftime('%d/%m/%y') if p.fecha_venta else '-' }}</td>
                        <td class="agente">
                            <span class="avatar">{{ p.usuario.nombre[:2]|upper if p.usuario else '??' }}</span>
                            {{ p.usuario.nombre.split()[0] if p.usuario else '-' }}
                        </td>
                        <td>{{ p.facturar_a or (p.empresa.nombre_empresa if p.empresa else '-') }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(p.total|float) }}</td>
                        <td>{{ p.forma_pago or '-' }}</td>
                        <td>
                            {% set dias = (fecha_actual - p.fecha_venta).days if p.fecha_venta else 0 %}
                            {% if dias > 3 %}
                            <span class="dias-pendiente danger">{{ dias }}d</span>
                            {% elif dias > 0 %}
                            <span class="dias-pendiente warning">{{ dias }}d</span>
                            {% else %}
                            <span class="dias-pendiente info">Hoy</span>
                            {% endif %}
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-accion btn-ver" onclick="verDetalle({{ p.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="empty-state success">
                            <i class="fas fa-check-circle"></i>
                            ¡Todas las papeletas están reportadas!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Tab: Sin Facturar -->
        <div class="tab-content" id="tab-sin_facturar">
            <table class="tabla-papeletas">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th class="text-right">Total</th>
                        <th>Reporte</th>
                        <th>Días</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in papeletas if p.reporte_venta_id and not p.numero_factura %}
                    <tr data-id="{{ p.id }}">
                        <td class="folio">{{ p.folio }}</td>
                        <td>{{ p.fecha_venta.strftime('%d/%m/%y') if p.fecha_venta else '-' }}</td>
                        <td>{{ p.facturar_a or (p.empresa.nombre_empresa if p.empresa else '-') }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(p.total|float) }}</td>
                        <td>
                            {% if p.reporte_venta %}
                            <a href="{{ url_for('main.ver_reporte_venta', id=p.reporte_venta_id) }}" class="folio" style="font-size: 0.8rem;">
                                {{ p.reporte_venta.folio }}
                            </a>
                            {% endif %}
                        </td>
                        <td>
                            {% set dias = (fecha_actual - p.fecha_venta).days if p.fecha_venta else 0 %}
                            {% if dias > 3 %}
                            <span class="dias-pendiente danger">{{ dias }}d</span>
                            {% elif dias > 0 %}
                            <span class="dias-pendiente warning">{{ dias }}d</span>
                            {% else %}
                            <span class="dias-pendiente info">Hoy</span>
                            {% endif %}
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-accion btn-ver" onclick="verDetalle({{ p.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if current_user.es_admin() %}
                            <button class="btn-accion btn-factura" onclick="asignarFactura({{ p.id }}, '{{ p.folio }}')">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="empty-state success">
                            <i class="fas fa-check-circle"></i>
                            ¡Todas las papeletas reportadas están facturadas!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Tab: Facturadas -->
        <div class="tab-content" id="tab-facturadas">
            <table class="tabla-papeletas">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th class="text-right">Total</th>
                        <th>Reporte</th>
                        <th>Factura</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in papeletas if p.numero_factura %}
                    <tr data-id="{{ p.id }}">
                        <td class="folio">{{ p.folio }}</td>
                        <td>{{ p.fecha_venta.strftime('%d/%m/%y') if p.fecha_venta else '-' }}</td>
                        <td>{{ p.facturar_a or (p.empresa.nombre_empresa if p.empresa else '-') }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(p.total|float) }}</td>
                        <td>
                            {% if p.reporte_venta %}
                            <a href="{{ url_for('main.ver_reporte_venta', id=p.reporte_venta_id) }}" class="folio" style="font-size: 0.8rem;">
                                {{ p.reporte_venta.folio }}
                            </a>
                            {% else %}
                            <span style="color: #9ca3af;">---</span>
                            {% endif %}
                        </td>
                        <td>
                            <span style="color: #059669; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> {{ p.numero_factura }}
                            </span>
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-accion btn-ver" onclick="verDetalle({{ p.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-file-invoice"></i>
                            No hay papeletas facturadas
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Tab: Hoy -->
        <div class="tab-content" id="tab-hoy">
            <table class="tabla-papeletas">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Agente</th>
                        <th>Cliente</th>
                        <th class="text-right">Total</th>
                        <th>Forma Pago</th>
                        <th>Estatus</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in papeletas if p.fecha_venta == fecha_actual %}
                    <tr data-id="{{ p.id }}">
                        <td class="folio">{{ p.folio }}</td>
                        <td class="agente">
                            <span class="avatar">{{ p.usuario.nombre[:2]|upper if p.usuario else '??' }}</span>
                            {{ p.usuario.nombre.split()[0] if p.usuario else '-' }}
                        </td>
                        <td>{{ p.facturar_a or (p.empresa.nombre_empresa if p.empresa else '-') }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(p.total|float) }}</td>
                        <td>{{ p.forma_pago or '-' }}</td>
                        <td>
                            {% if p.numero_factura and p.numero_factura|upper != 'N/A' %}
                            <span class="badge-estado facturada"><i class="fas fa-check"></i> Facturada</span>
                            {% elif p.reporte_venta_id or p.numero_factura|upper == 'N/A' %}
                            <span class="badge-estado reportada"><i class="fas fa-chart-bar"></i> Reportada</span>
                            {% else %}
                            <span class="badge-estado sin-reportar"><i class="fas fa-times"></i> Sin reportar</span>
                            {% endif %}
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-accion btn-ver" onclick="verDetalle({{ p.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-calendar-day"></i>
                            No hay papeletas de hoy
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Panel Detalle -->
<div class="panel-overlay" id="panelOverlay" onclick="cerrarPanel()"></div>
<div class="panel-detalle" id="panelDetalle">
    <div class="panel-header">
        <h3><i class="fas fa-file-alt"></i> <span id="panelFolio">Detalle</span></h3>
        <button class="panel-close" onclick="cerrarPanel()">&times;</button>
    </div>
    <div class="panel-body" id="panelBody">
        <!-- Contenido cargado por JS -->
    </div>
    <div class="panel-footer" id="panelFooter">
        <!-- Acciones según estatus -->
    </div>
</div>

<!-- Modal Asignar Factura -->
<div class="modal-overlay" id="modalFactura">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-invoice"></i> Asignar Factura</h3>
            <button type="button" class="modal-close" onclick="cerrarModalFactura()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Papeleta: <strong id="facturaFolio"></strong></p>
            <div class="form-group">
                <label>Número de Factura</label>
                <input type="text" id="numeroFactura" placeholder="Ej: F-12345" style="width:100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModalFactura()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="guardarFactura()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal Subir Archivo -->
<div class="modal-overlay" id="modalArchivo">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
            <h3><i class="fas fa-file-pdf"></i> Subir PDF del Boleto</h3>
            <button type="button" class="modal-close" onclick="cerrarModalArchivo()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 1rem;">Papeleta: <strong id="archivoFolio"></strong></p>
            <div class="archivo-upload-area" id="archivoUploadArea">
                <input type="file" id="archivoInput" accept=".pdf" style="display: none;">
                <div class="upload-placeholder" onclick="document.getElementById('archivoInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #3b82f6; margin-bottom: 0.75rem;"></i>
                    <p style="margin: 0; font-weight: 600; color: #1e40af;">Click para seleccionar PDF</p>
                    <small style="color: #6b7280;">o arrastra el archivo aquí</small>
                </div>
                <div class="upload-selected" style="display: none;">
                    <i class="fas fa-file-pdf" style="font-size: 2rem; color: #10b981;"></i>
                    <span id="archivoSeleccionado"></span>
                    <button type="button" onclick="limpiarArchivo()" style="background: none; border: none; color: #dc2626; cursor: pointer;">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            </div>
            <small style="display: block; margin-top: 0.5rem; color: #6b7280;">
                <i class="fas fa-info-circle"></i> Solo archivos PDF, máximo 10MB
            </small>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModalArchivo()">Cancelar</button>
            <button type="button" class="btn-primary" id="btnGuardarArchivo" onclick="guardarArchivo()" disabled>
                <i class="fas fa-upload"></i> Subir Archivo
            </button>
        </div>
    </div>
</div>

<style>
.archivo-upload-area {
    border: 2px dashed #93c5fd;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    background: #eff6ff;
    transition: all 0.3s;
    cursor: pointer;
}
.archivo-upload-area:hover {
    border-color: #3b82f6;
    background: #dbeafe;
}
.archivo-upload-area.dragover {
    border-color: #10b981;
    background: #d1fae5;
}
.archivo-upload-area.has-file {
    border-style: solid;
    border-color: #10b981;
    background: #d1fae5;
}
.upload-selected {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}
.upload-selected span {
    font-weight: 600;
    color: #065f46;
}
</style>

<script>
// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});

function cambiarTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
        if (b.dataset.tab === tab) b.classList.add('active');
    });
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
}

// Panel Detalle
var papeletaActual = null;

function verDetalle(id) {
    papeletaActual = id;
    
    fetch('/api/papeleta/' + id)
        .then(r => {
            if (!r.ok) {
                throw new Error('Error HTTP: ' + r.status);
            }
            const contentType = r.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('La sesión ha expirado. Por favor recarga la página.');
            }
            return r.json();
        })
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            document.getElementById('panelFolio').textContent = data.folio;
            document.getElementById('panelBody').innerHTML = renderDetalle(data);
            
            // Mostrar acciones según estatus
            let footerHTML = '';
            if (!data.numero_factura) {
                footerHTML = `
                    <button class="btn btn-pendiente" onclick="cerrarPanel()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button class="btn btn-validar-full" onclick="asignarFactura(${id}, '${data.folio}')">
                        <i class="fas fa-file-invoice"></i> Asignar Factura
                    </button>
                `;
            } else {
                footerHTML = `
                    <button class="btn btn-validar-full" onclick="cerrarPanel()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        <i class="fas fa-check"></i> Cerrar
                    </button>
                `;
            }
            document.getElementById('panelFooter').innerHTML = footerHTML;
            
            document.getElementById('panelDetalle').classList.add('active');
            document.getElementById('panelOverlay').classList.add('active');
        })
        .catch(err => {
            alert('Error al cargar detalle: ' + err.message);
        });
}

function renderDetalle(p) {
    let estatusHTML = '';
    if (p.numero_factura && p.numero_factura.toUpperCase() !== 'N/A') {
        estatusHTML = '<span class="badge-estado facturada"><i class="fas fa-check"></i> Facturada</span>';
    } else if (p.reporte_venta_id || (p.numero_factura && p.numero_factura.toUpperCase() === 'N/A')) {
        estatusHTML = '<span class="badge-estado reportada"><i class="fas fa-chart-bar"></i> Reportada</span>';
    } else {
        estatusHTML = '<span class="badge-estado sin-reportar"><i class="fas fa-times"></i> Sin reportar</span>';
    }
    
    // Sección del archivo PDF
    let archivoHTML = '';
    if (p.archivo_boleto) {
        archivoHTML = `
            <div class="detalle-section archivo-section-panel">
                <h4><i class="fas fa-file-pdf"></i> Boleto PDF</h4>
                <div class="archivo-actions">
                    <a href="/static/uploads/boletos/${p.archivo_boleto}" target="_blank" class="btn-archivo btn-ver-pdf">
                        <i class="fas fa-eye"></i> Ver PDF
                    </a>
                    <a href="/static/uploads/boletos/${p.archivo_boleto}" download class="btn-archivo btn-descargar">
                        <i class="fas fa-download"></i> Descargar
                    </a>
                </div>
                <div class="archivo-info">
                    <small class="archivo-nombre"><i class="fas fa-paperclip"></i> ${p.archivo_boleto}</small>
                    <button type="button" class="btn-cambiar-archivo" onclick="cambiarArchivo(${p.id})">
                        <i class="fas fa-sync-alt"></i> Cambiar
                    </button>
                </div>
            </div>
        `;
    } else {
        archivoHTML = `
            <div class="detalle-section archivo-section-panel sin-archivo">
                <h4><i class="fas fa-file-pdf"></i> Boleto PDF</h4>
                <div class="archivo-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>No hay archivo adjunto</span>
                </div>
                <button type="button" class="btn-subir-archivo" onclick="subirArchivo(${p.id})">
                    <i class="fas fa-upload"></i> Subir PDF del Boleto
                </button>
            </div>
        `;
    }
    
    return `
        <div class="detalle-section">
            <h4><i class="fas fa-info-circle"></i> Información General</h4>
            <div class="detalle-row"><span class="label">Folio</span><span class="value">${p.folio}</span></div>
            <div class="detalle-row"><span class="label">Fecha</span><span class="value">${p.fecha_venta}</span></div>
            <div class="detalle-row"><span class="label">Tarjeta</span><span class="value">${p.tarjeta_nombre || '**** ' + p.tarjeta}</span></div>
            <div class="detalle-row"><span class="label">Cliente</span><span class="value">${p.facturar_a || '---'}</span></div>
            <div class="detalle-row"><span class="label">Aerolínea</span><span class="value">${p.aerolinea || p.proveedor || '---'}</span></div>
        </div>
        ${archivoHTML}
        <div class="detalle-section">
            <h4><i class="fas fa-dollar-sign"></i> Importes</h4>
            <div class="detalle-row"><span class="label">Total Ticket</span><span class="value">$${Number(p.total_ticket).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
            <div class="detalle-row"><span class="label">10%</span><span class="value">$${Number(p.diez_porciento).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
            <div class="detalle-row"><span class="label">Cargo</span><span class="value">$${Number(p.cargo).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
            <div class="detalle-row"><span class="label">Total</span><span class="value" style="font-size:1.1rem;color:#059669;">$${Number(p.total).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
        </div>
        <div class="detalle-section">
            <h4><i class="fas fa-clipboard-check"></i> Estatus</h4>
            <div class="detalle-row"><span class="label">Estado</span><span class="value">${estatusHTML}</span></div>
            <div class="detalle-row"><span class="label">Reporte</span><span class="value">${p.reporte_folio || '---'}</span></div>
            <div class="detalle-row"><span class="label">Factura</span><span class="value">${p.numero_factura || '---'}</span></div>
            <div class="detalle-row"><span class="label">Forma Pago</span><span class="value">${p.forma_pago || '---'}</span></div>
        </div>
        <div class="detalle-section">
            <h4><i class="fas fa-user"></i> Registro</h4>
            <div class="detalle-row"><span class="label">Creado por</span><span class="value">${p.usuario}</span></div>
            <div class="detalle-row"><span class="label">Fecha registro</span><span class="value">${p.created_at}</span></div>
        </div>
    `;
}

function cerrarPanel() {
    document.getElementById('panelDetalle').classList.remove('active');
    document.getElementById('panelOverlay').classList.remove('active');
    papeletaActual = null;
}

// Modal Factura
var facturaId = null;

function asignarFactura(id, folio) {
    facturaId = id;
    document.getElementById('facturaFolio').textContent = folio;
    document.getElementById('numeroFactura').value = '';
    document.getElementById('modalFactura').classList.add('active');
    cerrarPanel();
}

function cerrarModalFactura() {
    document.getElementById('modalFactura').classList.remove('active');
    facturaId = null;
}

function guardarFactura() {
    const numero = document.getElementById('numeroFactura').value.trim();
    
    fetch('/api/papeleta/' + facturaId + '/factura', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({numero_factura: numero})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cerrarModalFactura();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'No se pudo guardar'));
        }
    })
    .catch(err => {
        alert('Error de conexión: ' + err.message);
    });
}

// Modal Archivo
var archivoId = null;
var archivoFolio = null;

function subirArchivo(id) {
    archivoId = id;
    // Obtener el folio de la papeleta actual
    fetch('/api/papeleta/' + id)
        .then(r => r.json())
        .then(data => {
            archivoFolio = data.folio;
            document.getElementById('archivoFolio').textContent = data.folio;
            document.getElementById('modalArchivo').classList.add('active');
            cerrarPanel();
        });
}

function cambiarArchivo(id) {
    subirArchivo(id);
}

function cerrarModalArchivo() {
    document.getElementById('modalArchivo').classList.remove('active');
    limpiarArchivo();
    archivoId = null;
    archivoFolio = null;
}

function limpiarArchivo() {
    const input = document.getElementById('archivoInput');
    input.value = '';
    document.querySelector('.upload-placeholder').style.display = 'block';
    document.querySelector('.upload-selected').style.display = 'none';
    document.getElementById('archivoUploadArea').classList.remove('has-file');
    document.getElementById('btnGuardarArchivo').disabled = true;
}

// Manejo del input de archivo
document.getElementById('archivoInput').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Solo se permiten archivos PDF');
            limpiarArchivo();
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('El archivo es muy grande. Máximo 10MB.');
            limpiarArchivo();
            return;
        }
        
        document.getElementById('archivoSeleccionado').textContent = file.name;
        document.querySelector('.upload-placeholder').style.display = 'none';
        document.querySelector('.upload-selected').style.display = 'flex';
        document.getElementById('archivoUploadArea').classList.add('has-file');
        document.getElementById('btnGuardarArchivo').disabled = false;
    }
});

// Drag and drop
const uploadArea = document.getElementById('archivoUploadArea');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const input = document.getElementById('archivoInput');
        input.files = files;
        input.dispatchEvent(new Event('change'));
    }
});

function guardarArchivo() {
    const input = document.getElementById('archivoInput');
    if (!input.files || !input.files[0]) {
        alert('Selecciona un archivo PDF');
        return;
    }
    
    const formData = new FormData();
    formData.append('archivo_boleto', input.files[0]);
    
    document.getElementById('btnGuardarArchivo').disabled = true;
    document.getElementById('btnGuardarArchivo').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
    
    fetch('/api/papeleta/' + archivoId + '/archivo', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cerrarModalArchivo();
            // Recargar el panel con los nuevos datos
            verDetalle(archivoId);
            alert('Archivo subido correctamente');
        } else {
            alert('Error: ' + (data.error || 'No se pudo subir el archivo'));
            document.getElementById('btnGuardarArchivo').disabled = false;
            document.getElementById('btnGuardarArchivo').innerHTML = '<i class="fas fa-upload"></i> Subir Archivo';
        }
    })
    .catch(err => {
        alert('Error de conexión: ' + err.message);
        document.getElementById('btnGuardarArchivo').disabled = false;
        document.getElementById('btnGuardarArchivo').innerHTML = '<i class="fas fa-upload"></i> Subir Archivo';
    });
}

// Cerrar modales con Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cerrarPanel();
        cerrarModalFactura();
        cerrarModalArchivo();
    }
});

// Click fuera del modal
document.getElementById('modalFactura').addEventListener('click', function(e) {
    if (e.target === this) cerrarModalFactura();
});

document.getElementById('modalArchivo').addEventListener('click', function(e) {
    if (e.target === this) cerrarModalArchivo();
});
</script>
{% endblock %}