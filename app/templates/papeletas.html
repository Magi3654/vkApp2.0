{% extends "base.html" %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stylespapeletas.css') }}">
    <style>
        .extemporanea-section {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border: 2px solid #ec4899;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .extemporanea-section.active { background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%); }
        .extemporanea-header { display: flex; align-items: center; gap: 0.75rem; }
        .extemporanea-header input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .extemporanea-header label { font-weight: 600; color: #9d174d; cursor: pointer; margin: 0; }
        .extemporanea-fields { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #db2777; }
        .extemporanea-fields.active { display: block; }
        .extemporanea-fields .form-group { margin-bottom: 1rem; }
        .extemporanea-fields label { color: #9d174d; font-weight: 500; }
        .extemporanea-fields textarea { min-height: 80px; resize: vertical; }
        .extemporanea-warning { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #9d174d; margin-top: 0.5rem; background: rgba(255,255,255,0.5); padding: 0.5rem; border-radius: 6px; }
        
        .reembolso-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .reembolso-section.active { background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%); }
        .reembolso-header { display: flex; align-items: center; gap: 0.75rem; }
        .reembolso-header input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .reembolso-header label { font-weight: 600; color: #92400e; cursor: pointer; margin: 0; }
        .reembolso-fields { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #d97706; }
        .reembolso-fields.active { display: block; }
        .reembolso-fields .form-group { margin-bottom: 1rem; }
        .reembolso-fields label { color: #92400e; font-weight: 500; }
        .reembolso-fields textarea { min-height: 60px; resize: vertical; }
        .reembolso-fields .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .reembolso-warning { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #92400e; margin-top: 0.5rem; }
    </style>
{% endblock %}

{% block content %}
<div class="crud-container-single">
    <div class="form-section">
        <div class="form-header">
            <h2>Registrar Nueva Papeleta</h2>
            <p>Completa la informaci칩n del cargo a tarjeta de cr칠dito.</p>
        </div>
        
        <form id="formPapeleta" action="{{ url_for('main.nueva_papeleta_post') }}" method="POST" class="crud-form">
            
            <div class="extemporanea-section" id="extemporaneaSection">
                <div class="extemporanea-header">
                    <input type="checkbox" id="extemporanea" name="extemporanea" value="1">
                    <label for="extemporanea"><i class="fas fa-clock"></i> Es papeleta extempor치nea (cargo ya realizado, registro tard칤o)</label>
                </div>
                <div class="extemporanea-fields" id="extemporaneaFields">
                    <div class="extemporanea-warning">
                        <i class="fas fa-exclamation-triangle"></i> Las papeletas extempor치neas no requieren autorizaci칩n de tarjeta ya que el cargo ya fue procesado.
                    </div>
                    <div class="form-group">
                        <label for="fecha_cargo_real">Fecha real del cargo *</label>
                        <input type="date" id="fecha_cargo_real" name="fecha_cargo_real">
                        <small>Fecha en que realmente se hizo el cargo a la tarjeta</small>
                    </div>
                    <div class="form-group">
                        <label for="motivo_extemporanea">Motivo del registro tard칤o *</label>
                        <textarea id="motivo_extemporanea" name="motivo_extemporanea" placeholder="Explica por qu칠 no se registr칩 a tiempo"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="reembolso-section" id="reembolsoSection">
                <div class="reembolso-header">
                    <input type="checkbox" id="tiene_reembolso" name="tiene_reembolso" value="1">
                    <label for="tiene_reembolso"><i class="fas fa-undo"></i> Este cargo tiene/tendr치 reembolso (duplicado, cancelaci칩n, error)</label>
                </div>
                <div class="reembolso-fields" id="reembolsoFields">
                    <div class="reembolso-warning">
                        <i class="fas fa-lightbulb"></i> Usa esta opci칩n para cargos duplicados, boletos cancelados o errores que ser치n reembolsados.
                    </div>
                    <div class="form-group">
                        <label for="motivo_reembolso">Motivo del reembolso *</label>
                        <select id="motivo_reembolso" name="motivo_reembolso">
                            <option value="">Selecciona el motivo...</option>
                            <option value="duplicado">Compra duplicada (doble cargo)</option>
                            <option value="cancelacion">Cancelaci칩n de boleto/reserva</option>
                            <option value="cambio">Cambio de itinerario con diferencia</option>
                            <option value="error_monto">Error en el monto cobrado</option>
                            <option value="no_show">No show (pasajero no se present칩)</option>
                            <option value="otro">Otro motivo</option>
                        </select>
                    </div>
                    <div class="form-group" id="motivoOtroGroup" style="display: none;">
                        <label for="motivo_reembolso_otro">Especifica el motivo *</label>
                        <textarea id="motivo_reembolso_otro" name="motivo_reembolso_otro" placeholder="Describe el motivo del reembolso..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="monto_reembolso">Monto a reembolsar *</label>
                            <input type="number" step="0.01" min="0" id="monto_reembolso" name="monto_reembolso" placeholder="0.00" class="monto-input">
                            <small>Deja en 0 si es reembolso total del ticket</small>
                        </div>
                        <div class="form-group">
                            <label for="estatus_reembolso">Estatus del reembolso</label>
                            <select id="estatus_reembolso" name="estatus_reembolso">
                                <option value="pendiente">Pendiente de solicitar</option>
                                <option value="en_proceso">En proceso con aerol칤nea</option>
                                <option value="completado">Reembolso recibido</option>
                                <option value="rechazado">Rechazado</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha_solicitud_reembolso">Fecha de solicitud</label>
                            <input type="date" id="fecha_solicitud_reembolso" name="fecha_solicitud_reembolso">
                        </div>
                        <div class="form-group">
                            <label for="referencia_reembolso">Referencia / Caso</label>
                            <input type="text" id="referencia_reembolso" name="referencia_reembolso" placeholder="Ej: CASO-12345, REF-ABC">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="papeleta_relacionada">Papeleta relacionada (si es duplicado)</label>
                        <input type="text" id="papeleta_relacionada" name="papeleta_relacionada_folio" placeholder="Folio de la otra papeleta (ej: 8821-015)">
                        <small>Si es compra duplicada, indica el folio de la otra papeleta</small>
                    </div>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-column">
                    <div class="form-group">
                        <label for="tarjeta_id">Tarjeta Corporativa *</label>
                        <div class="dropdown-input" id="dropdownContainer">
                            <select id="tarjeta_id" name="tarjeta_id">
                                <option value="">Selecciona una tarjeta...</option>
                                {% for item in tarjetas_info %}
                                    <option value="{{ item.tarjeta.id }}" 
                                            data-numero="{{ item.tarjeta.numero_tarjeta }}"
                                            data-requiere="{{ item.requiere_autorizacion|lower }}"
                                            data-tiene-auth="{{ item.tiene_autorizacion|lower }}"
                                            data-puede-usar="{{ item.puede_usar|lower }}"
                                            data-usuarios="{{ item.usuarios_asignados|join(', ') if item.usuarios_asignados else '' }}"
                                            data-tiempo-restante="{{ item.tiempo_restante or '' }}"
                                            data-fecha-expiracion="{{ item.fecha_expiracion or '' }}"
                                            class="{% if item.puede_usar %}tarjeta-disponible{% else %}tarjeta-bloqueada{% endif %}">
                                        {{ item.tarjeta.nombre_tarjeta }} ({{ item.tarjeta.numero_tarjeta }})
                                        {% if item.puede_usar %}九늩% else %}游눁% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <span class="toggle-link" id="toggleManual">쯅o encuentras la tarjeta? Ingresar manualmente</span>
                        <div class="manual-input" id="manualContainer">
                            <input type="text" id="tarjeta_manual" name="tarjeta_manual" maxlength="4" pattern="\d{4}" placeholder="칔ltimos 4 d칤gitos">
                            <span class="toggle-link" id="toggleDropdown">Volver al selector</span>
                        </div>
                        <div id="tarjetaInfo" class="tarjeta-info"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="folio">Folio</label>
                        <input type="text" id="folio" name="folio" readonly required>
                        <small>Se genera autom치ticamente</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_venta">Fecha de Venta *</label>
                        <input type="date" id="fecha_venta" name="fecha_venta" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="facturar_a">Facturar a *</label>
                        <select id="facturar_a" name="facturar_a" required>
                            <option value="">Selecciona una empresa...</option>
                            {% for empresa in empresas %}
                                <option value="{{ empresa.id }}">{{ empresa.nombre_empresa }}</option>
                            {% endfor %}
                        </select>
                        <small id="cargoEmpresaInfo"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_cargo">Tipo de Cargo *</label>
                        <select id="tipo_cargo" name="tipo_cargo" required>
                            <option value="">Selecciona...</option>
                            <option value="aerolinea">Aerol칤nea</option>
                            <option value="hotel">Hotel</option>
                            <option value="auto">Renta de Auto</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="aerolineaGroup">
                        <label for="aerolinea_id">Aerol칤nea</label>
                        <select id="aerolinea_id" name="aerolinea_id">
                            <option value="">Selecciona una aerol칤nea...</option>
                            {% for aerolinea in aerolineas %}
                                <option value="{{ aerolinea.id }}">{{ aerolinea.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group" id="proveedorGroup" style="display: none;">
                        <label for="proveedor">Nombre del Proveedor *</label>
                        <input type="text" id="proveedor" name="proveedor" placeholder="Ej: Marriott, Hertz, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="solicito">Solicit칩 *</label>
                        <input type="text" id="solicito" name="solicito" required placeholder="Nombre del solicitante" style="text-transform: uppercase;">
                    </div>
                </div>
                
                <div class="form-column">
                    <div class="form-group">
                        <label for="clave_sabre">Clave Sabre / Reserva *</label>
                        <input type="text" id="clave_sabre" name="clave_sabre" required placeholder="Ej: ABC123" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="forma_pago">Forma de Pago</label>
                        <select id="forma_pago" name="forma_pago">
                            <option value="">Selecciona...</option>
                            <option value="Cr칠dito">Cr칠dito</option>
                            <option value="Contado">Contado</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Dep칩sito">Dep칩sito</option>
                        </select>
                    </div>
                    
                    <div class="montos-section">
                        <h4><i class="fas fa-dollar-sign"></i> Desglose de Montos</h4>
                        
                        <div class="form-group">
                            <label for="total_ticket">Total del Ticket *</label>
                            <input type="number" step="0.01" min="0" id="total_ticket" name="total_ticket" required placeholder="0.00" class="monto-input">
                        </div>
                        
                        <div class="form-group">
                            <label for="diez_porciento">
                                10% Comisi칩n
                                <input type="checkbox" id="check_comision" checked style="margin-left: 0.5rem;">
                                <button type="button" class="btn-calcular" id="btnCalcular10" title="Calcular 10%"><i class="fas fa-calculator"></i></button>
                            </label>
                            <input type="number" step="0.01" min="0" id="diez_porciento" name="diez_porciento" placeholder="0.00" class="monto-input" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="cargo">Cargo Visible <small>(facturado)</small></label>
                            <input type="number" step="0.01" min="0" id="cargo" name="cargo" placeholder="0.00" class="monto-input" value="0">
                            <small id="cargoEmpresaInfo"></small>
                        </div>
                        
                        <div class="form-group" id="cargoOcultoGroup" style="display: none;">
                            <label for="cargo_oculto"><i class="fas fa-eye-slash"></i> Cargo Oculto <small>(incluido en tarifa)</small></label>
                            <input type="number" step="0.01" min="0" id="cargo_oculto" name="cargo_oculto" placeholder="0.00" class="monto-input monto-oculto" value="0" readonly>
                            <small>Este cargo se agrega al total pero no se factura por separado</small>
                        </div>
                        
                        <div class="form-group total-group">
                            <label for="total">TOTAL A COBRAR</label>
                            <input type="number" step="0.01" min="0" id="total" name="total" required readonly class="monto-total">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('main.consulta_papeletas') }}" class="btn-cancel">Cancelar</a>
                <button type="submit" id="btnSubmit" class="btn-submit" disabled><i class="fas fa-save"></i> Guardar Papeleta</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="modalAutorizacion">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-lock"></i> Solicitar Autorizaci칩n</h3>
            <button type="button" class="modal-close" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
        </div>
        <form action="{{ url_for('main.solicitar_autorizacion') }}" method="POST">
            <div class="modal-body">
                <p>No tienes acceso a esta tarjeta. Necesitas autorizaci칩n de Direcci칩n General.</p>
                <input type="hidden" name="tarjeta_id" id="modal_tarjeta_id">
                <div class="form-group">
                    <label for="motivo">Motivo de la solicitud: *</label>
                    <textarea name="motivo" id="motivo" required rows="4" placeholder="Ej: Cliente urgente, tarjeta de sucursal sin fondos, etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-submit"><i class="fas fa-paper-plane"></i> Enviar Solicitud</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tarjetaSelect = document.getElementById('tarjeta_id');
    const tarjetaManual = document.getElementById('tarjeta_manual');
    const folioInput = document.getElementById('folio');
    const tarjetaInfo = document.getElementById('tarjetaInfo');
    const btnSubmit = document.getElementById('btnSubmit');
    const toggleManual = document.getElementById('toggleManual');
    const toggleDropdown = document.getElementById('toggleDropdown');
    const dropdownContainer = document.getElementById('dropdownContainer');
    const manualContainer = document.getElementById('manualContainer');
    const formPapeleta = document.getElementById('formPapeleta');
    const totalTicket = document.getElementById('total_ticket');
    const diezPorciento = document.getElementById('diez_porciento');
    const cargo = document.getElementById('cargo');
    const totalFinal = document.getElementById('total');
    const btnCalcular10 = document.getElementById('btnCalcular10');
    const empresaSelect = document.getElementById('facturar_a');
    const cargoEmpresaInfo = document.getElementById('cargoEmpresaInfo');
    
    let modoManual = false;
    let puedeEnviar = false;
    
    toggleManual.addEventListener('click', function() {
        modoManual = true;
        dropdownContainer.classList.add('hidden');
        manualContainer.classList.add('active');
        tarjetaSelect.value = '';
        tarjetaInfo.style.display = 'none';
        tarjetaInfo.innerHTML = '';
        puedeEnviar = true;
        actualizarBoton();
    });
    
    toggleDropdown.addEventListener('click', function() {
        modoManual = false;
        dropdownContainer.classList.remove('hidden');
        manualContainer.classList.remove('active');
        tarjetaManual.value = '';
        folioInput.value = '';
        puedeEnviar = false;
        actualizarBoton();
    });
    
    tarjetaSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (!this.value) {
            tarjetaInfo.style.display = 'none';
            tarjetaInfo.innerHTML = '';
            folioInput.value = '';
            puedeEnviar = false;
            actualizarBoton();
            return;
        }
        
        const numero = option.dataset.numero;
        const puedeUsar = option.dataset.puedeUsar === 'true';
        const usuariosAsignados = option.dataset.usuarios;
        const tiempoRestante = option.dataset.tiempoRestante;
        const fechaExpiracion = option.dataset.fechaExpiracion;
        
        tarjetaInfo.style.display = 'block';
        
        if (puedeUsar) {
            tarjetaInfo.className = 'tarjeta-info puede-usar';
            let html = '<i class="fas fa-check-circle"></i> Puedes usar esta tarjeta.';
            if (tiempoRestante) {
                html += `<br><small><i class="fas fa-stopwatch"></i> <strong>Autorizaci칩n temporal:</strong> expira en ${tiempoRestante}</small>`;
                html += `<br><small><i class="fas fa-calendar"></i> V치lida hasta: ${fechaExpiracion}</small>`;
            } else if (usuariosAsignados) {
                html += `<br><small><i class="fas fa-users"></i> Asignada a: ${usuariosAsignados}</small>`;
            }
            tarjetaInfo.innerHTML = html;
            puedeEnviar = true;
        } else {
            tarjetaInfo.className = 'tarjeta-info sin-auth';
            let html = '<i class="fas fa-lock"></i> No tienes acceso a esta tarjeta.';
            if (usuariosAsignados) {
                html += `<br><small><i class="fas fa-users"></i> Asignada a: ${usuariosAsignados}</small>`;
            }
            html += `<br><small><i class="fas fa-lightbulb"></i> Puedes solicitar autorizaci칩n temporal (v치lida por 24 horas)</small>`;
            html += `<br><button type="button" class="btn-solicitar-auth" onclick="abrirModalAutorizacion(${this.value})"><i class="fas fa-key"></i> Solicitar Autorizaci칩n (24 hrs)</button>`;
            tarjetaInfo.innerHTML = html;
            puedeEnviar = false;
        }
        
        actualizarBoton();
        
        if (numero) {
            fetch(`/api/siguiente-folio-papeleta?tarjeta=${numero}`)
                .then(response => response.json())
                .then(data => { if (data.folio) folioInput.value = data.folio; })
                .catch(error => console.error('Error:', error));
        }
    });
    
    tarjetaManual.addEventListener('input', function() {
        const tarjeta = this.value;
        if (tarjeta.length === 4 && /^\d{4}$/.test(tarjeta)) {
            fetch(`/api/siguiente-folio-papeleta?tarjeta=${tarjeta}`)
                .then(response => response.json())
                .then(data => { if (data.folio) folioInput.value = data.folio; })
                .catch(error => console.error('Error:', error));
            puedeEnviar = true;
        } else {
            folioInput.value = '';
            puedeEnviar = false;
        }
        actualizarBoton();
    });
    
    function calcularTotal() {
        const ticket = parseFloat(totalTicket.value) || 0;
        const comision = parseFloat(diezPorciento.value) || 0;
        const cargoServicio = parseFloat(cargo.value) || 0;
        const cargoOcultoVal = parseFloat(document.getElementById('cargo_oculto').value) || 0;
        totalFinal.value = (ticket + comision + cargoServicio + cargoOcultoVal).toFixed(2);
    }
    
    btnCalcular10.addEventListener('click', function() {
        const ticket = parseFloat(totalTicket.value) || 0;
        diezPorciento.value = (ticket * 0.10).toFixed(2);
        calcularTotal();
    });
    
    totalTicket.addEventListener('input', calcularTotal);
    diezPorciento.addEventListener('input', calcularTotal);
    cargo.addEventListener('input', calcularTotal);
    
    empresaSelect.addEventListener('change', function() {
        const empresaId = this.value;
        const cargoOcultoInput = document.getElementById('cargo_oculto');
        const cargoOcultoGroup = document.getElementById('cargoOcultoGroup');
        const tipoCargoSelect = document.getElementById('tipo_cargo');
        const tipoServicio = tipoCargoSelect.value === 'aerolinea' ? 'nacional' : (tipoCargoSelect.value || 'nacional');
        
        if (!empresaId) {
            cargoEmpresaInfo.innerHTML = '';
            cargo.value = '0';
            cargoOcultoInput.value = '0';
            cargoOcultoGroup.style.display = 'none';
            calcularTotal();
            return;
        }
        
        fetch(`/api/cargos-empresa/${empresaId}?tipo_servicio=${tipoServicio}`)
            .then(response => response.json())
            .then(data => {
                const cargoVisible = data.cargo_visible || 0;
                const cargoOculto = data.cargo_oculto || 0;
                
                cargo.value = cargoVisible.toFixed(2);
                cargoOcultoInput.value = cargoOculto.toFixed(2);
                
                // Mostrar/ocultar campo de cargo oculto
                if (cargoOculto > 0) {
                    cargoOcultoGroup.style.display = 'block';
                } else {
                    cargoOcultoGroup.style.display = 'none';
                }
                
                // Info de cargos
                let info = '';
                if (cargoVisible > 0) info += `<i class="fas fa-eye"></i> $${cargoVisible.toFixed(2)}`;
                if (cargoOculto > 0) info += (info ? ' + ' : '') + `<i class="fas fa-eye-slash"></i> $${cargoOculto.toFixed(2)} oculto`;
                if (!info) info = '<i class="fas fa-info-circle"></i> Sin cargos configurados';
                
                cargoEmpresaInfo.innerHTML = info;
                cargoEmpresaInfo.style.color = (cargoVisible > 0 || cargoOculto > 0) ? '#28a745' : '#6c757d';
                
                calcularTotal();
            })
            .catch(error => { 
                console.error('Error:', error); 
                cargoEmpresaInfo.innerHTML = ''; 
                cargoOcultoGroup.style.display = 'none';
            });
    });
    
    // Recargar cargos cuando cambie el tipo de cargo
    document.getElementById('tipo_cargo').addEventListener('change', function() {
        if (empresaSelect.value) {
            empresaSelect.dispatchEvent(new Event('change'));
        }
    });
    
    function actualizarBoton() {
        btnSubmit.disabled = !puedeEnviar;
        btnSubmit.classList.toggle('disabled', !puedeEnviar);
    }
    
    const extemporaneaCheckbox = document.getElementById('extemporanea');
    const extemporaneaSection = document.getElementById('extemporaneaSection');
    const extemporaneaFields = document.getElementById('extemporaneaFields');
    const fechaCargoReal = document.getElementById('fecha_cargo_real');
    const motivoExtemporanea = document.getElementById('motivo_extemporanea');
    let esExtemporanea = false;
    
    extemporaneaCheckbox.addEventListener('change', function() {
        esExtemporanea = this.checked;
        extemporaneaSection.classList.toggle('active', esExtemporanea);
        extemporaneaFields.classList.toggle('active', esExtemporanea);
        
        if (esExtemporanea) {
            fechaCargoReal.required = true;
            motivoExtemporanea.required = true;
            const selectedOption = tarjetaSelect.options[tarjetaSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                puedeEnviar = true;
                tarjetaInfo.className = 'tarjeta-info puede-usar';
                tarjetaInfo.innerHTML = '<i class="fas fa-check-circle"></i> Papeleta extempor치nea - No requiere autorizaci칩n.<br><small><i class="fas fa-clock"></i> El cargo ya fue procesado anteriormente.</small>';
                tarjetaInfo.style.display = 'block';
            }
        } else {
            fechaCargoReal.required = false;
            motivoExtemporanea.required = false;
            fechaCargoReal.value = '';
            motivoExtemporanea.value = '';
            if (tarjetaSelect.value) {
                tarjetaSelect.dispatchEvent(new Event('change'));
            } else if (tarjetaManual.value.length === 4) {
                puedeEnviar = true;
            } else {
                puedeEnviar = false;
            }
        }
        actualizarBoton();
    });
    
    tarjetaSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (!this.value) {
            tarjetaInfo.style.display = 'none';
            tarjetaInfo.innerHTML = '';
            folioInput.value = '';
            puedeEnviar = false;
            actualizarBoton();
            return;
        }
        
        const numero = option.dataset.numero;
        if (esExtemporanea) {
            tarjetaInfo.className = 'tarjeta-info puede-usar';
            tarjetaInfo.innerHTML = '<i class="fas fa-check-circle"></i> Papeleta extempor치nea - No requiere autorizaci칩n.<br><small><i class="fas fa-clock"></i> El cargo ya fue procesado anteriormente.</small>';
            tarjetaInfo.style.display = 'block';
            puedeEnviar = true;
        }
        
        actualizarBoton();
        
        if (numero) {
            fetch(`/api/siguiente-folio-papeleta?tarjeta=${numero}`)
                .then(response => response.json())
                .then(data => { if (data.folio) folioInput.value = data.folio; })
                .catch(error => console.error('Error:', error));
        }
    });
    
    const reembolsoCheckbox = document.getElementById('tiene_reembolso');
    const reembolsoSection = document.getElementById('reembolsoSection');
    const reembolsoFields = document.getElementById('reembolsoFields');
    const motivoReembolsoSelect = document.getElementById('motivo_reembolso');
    const motivoOtroGroup = document.getElementById('motivoOtroGroup');
    const montoReembolso = document.getElementById('monto_reembolso');
    let tieneReembolso = false;
    
    reembolsoCheckbox.addEventListener('change', function() {
        tieneReembolso = this.checked;
        reembolsoSection.classList.toggle('active', tieneReembolso);
        reembolsoFields.classList.toggle('active', tieneReembolso);
        
        if (tieneReembolso) {
            motivoReembolsoSelect.required = true;
        } else {
            motivoReembolsoSelect.required = false;
            motivoReembolsoSelect.value = '';
            montoReembolso.value = '';
            document.getElementById('referencia_reembolso').value = '';
            document.getElementById('fecha_solicitud_reembolso').value = '';
            document.getElementById('papeleta_relacionada').value = '';
            motivoOtroGroup.style.display = 'none';
        }
    });
    
    motivoReembolsoSelect.addEventListener('change', function() {
        if (this.value === 'otro') {
            motivoOtroGroup.style.display = 'block';
            document.getElementById('motivo_reembolso_otro').required = true;
        } else {
            motivoOtroGroup.style.display = 'none';
            document.getElementById('motivo_reembolso_otro').required = false;
            document.getElementById('motivo_reembolso_otro').value = '';
        }
    });
    
    totalTicket.addEventListener('change', function() {
        if (tieneReembolso && !montoReembolso.value) montoReembolso.value = this.value;
    });
    
    formPapeleta.addEventListener('submit', function(e) {
        if (!puedeEnviar) {
            e.preventDefault();
            alert('Debes seleccionar una tarjeta v치lida o solicitar autorizaci칩n.');
            return false;
        }
        if (esExtemporanea) {
            if (!fechaCargoReal.value) { e.preventDefault(); alert('Debes ingresar la fecha real del cargo.'); fechaCargoReal.focus(); return false; }
            if (!motivoExtemporanea.value.trim()) { e.preventDefault(); alert('Debes ingresar el motivo del registro tard칤o.'); motivoExtemporanea.focus(); return false; }
        }
        if (tieneReembolso) {
            if (!motivoReembolsoSelect.value) { e.preventDefault(); alert('Debes seleccionar el motivo del reembolso.'); motivoReembolsoSelect.focus(); return false; }
            if (motivoReembolsoSelect.value === 'otro' && !document.getElementById('motivo_reembolso_otro').value.trim()) { e.preventDefault(); alert('Debes especificar el motivo del reembolso.'); document.getElementById('motivo_reembolso_otro').focus(); return false; }
        }
        if (modoManual) { tarjetaSelect.value = ''; } else { tarjetaManual.value = ''; }
    });
    
    actualizarBoton();
    document.getElementById('fecha_venta').value = new Date().toISOString().split('T')[0];
    totalFinal.value = '0.00';
    
    const tipoCargo = document.getElementById('tipo_cargo');
    const aerolineaGroup = document.getElementById('aerolineaGroup');
    const proveedorGroup = document.getElementById('proveedorGroup');
    const aerolineaSelect = document.getElementById('aerolinea_id');
    const proveedorInput = document.getElementById('proveedor');
    
    tipoCargo.addEventListener('change', function() {
        const tipo = this.value;
        if (tipo === 'aerolinea') {
            aerolineaGroup.style.display = 'flex';
            proveedorGroup.style.display = 'none';
            aerolineaSelect.required = true;
            proveedorInput.required = false;
            proveedorInput.value = '';
        } else if (tipo === 'hotel' || tipo === 'auto' || tipo === 'otro') {
            aerolineaGroup.style.display = 'none';
            proveedorGroup.style.display = 'flex';
            aerolineaSelect.required = false;
            aerolineaSelect.value = '';
            proveedorInput.required = true;
            if (tipo === 'hotel') proveedorInput.placeholder = 'Ej: Marriott, Hilton, Holiday Inn...';
            else if (tipo === 'auto') proveedorInput.placeholder = 'Ej: Hertz, Avis, National...';
            else proveedorInput.placeholder = 'Especifica el proveedor o servicio...';
        } else {
            aerolineaGroup.style.display = 'flex';
            proveedorGroup.style.display = 'none';
            aerolineaSelect.required = false;
            proveedorInput.required = false;
        }
    });
});

function abrirModalAutorizacion(tarjetaId) {
    document.getElementById('modal_tarjeta_id').value = tarjetaId;
    document.getElementById('modalAutorizacion').classList.add('active');
}

function cerrarModal() {
    document.getElementById('modalAutorizacion').classList.remove('active');
    document.getElementById('motivo').value = '';
}

document.getElementById('modalAutorizacion').addEventListener('click', function(e) { if (e.target === this) cerrarModal(); });
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') cerrarModal(); });
</script>
{% endblock %}