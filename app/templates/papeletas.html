{% extends "base.html" %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stylespapeletas.css') }}">
{% endblock %}

{% block content %}
<div class="crud-container-single">
    <div class="form-section">
        <div class="form-header">
            <h2>Registrar Nueva Papeleta</h2>
            <p>Completa la información del cargo a tarjeta de crédito.</p>
        </div>
        
        <form action="{{ url_for('main.nueva_papeleta_post') }}" method="POST" class="crud-form">
            <div class="form-grid">
                <!-- Columna Izquierda -->
                <div class="form-column">
                    <div class="form-group">
                        <label for="tarjeta">Terminación Tarjeta (4 dígitos)</label>
                        <input type="text" id="tarjeta" name="tarjeta" required maxlength="4" pattern="\d{4}" title="Introduce los 4 dígitos de la tarjeta.">
                    </div>
                    <div class="form-group">
                        <label for="folio">Folio</label>
                        <input type="text" id="folio" name="folio" readonly required>
                        <small>Se genera automáticamente por tarjeta</small>
                    </div>
                    <div class="form-group">
                        <label for="fecha_venta">Fecha de Venta</label>
                        <input type="date" id="fecha_venta" name="fecha_venta" required>
                    </div>
                    <div class="form-group">
                        <label for="total_ticket">Total del Ticket</label>
                        <input type="number" step="0.01" id="total_ticket" name="total_ticket" required>
                    </div>
                    <div class="form-group">
                        <label for="diez_porciento">10%</label>
                        <input type="number" step="0.01" id="diez_porciento" name="diez_porciento" required>
                    </div>
                     <div class="form-group">
                        <label for="cargo">Cargo</label>
                        <input type="number" step="0.01" id="cargo" name="cargo" required>
                    </div>
                </div>
                <!-- Columna Derecha -->
                <div class="form-column">
                    <div class="form-group">
                        <label for="total">Total</label>
                        <input type="number" step="0.01" id="total" name="total" required>
                    </div>
                     <div class="form-group">
                        <label for="facturar_a">Facturar a</label>
                        <select id="facturar_a" name="facturar_a" required>
                            <option value="" disabled selected>Selecciona una empresa...</option>
                            {% for empresa in empresas %}
                                <option value="{{ empresa.id }}">{{ empresa.nombre_empresa }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aerolinea_id">Aerolínea</label>
                        <select id="aerolinea_id" name="aerolinea_id">
                            <option value="" disabled selected>Selecciona una aerolínea...</option>
                            {% for aerolinea in aerolineas %}
                                <option value="{{ aerolinea.id }}">{{ aerolinea.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="solicito">Solicitó</label>
                        <input type="text" id="solicito" name="solicito" required>
                    </div>
                    <div class="form-group">
                        <label for="clave_sabre">Clave Sabre</label>
                        <input type="text" id="clave_sabre" name="clave_sabre" required>
                    </div>
                    <div class="form-group">
                        <label for="forma_pago">Forma de Pago</label>
                        <input type="text" id="forma_pago" name="forma_pago" required>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-submit">Guardar Papeleta</button>
                <a href="{{ url_for('main.consulta_papeletas') }}" class="btn-cancel">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
// Generar folio automáticamente según la tarjeta
document.addEventListener('DOMContentLoaded', function() {
    const tarjetaInput = document.getElementById('tarjeta');
    const folioInput = document.getElementById('folio');

    tarjetaInput.addEventListener('input', function() {
        const tarjeta = this.value;

        // Solo buscar cuando tenga 4 dígitos
        if (tarjeta.length === 4 && /^\d{4}$/.test(tarjeta)) {
            fetch(`{{ url_for("main.siguiente_folio_papeleta") }}?tarjeta=${tarjeta}`)
                .then(response => response.json())
                .then(data => {
                    if (data.folio) {
                        folioInput.value = data.folio;
                    }
                })
                .catch(error => console.error('Error cargando folio:', error));
        } else {
            folioInput.value = '';
        }
    });
});
</script>
{% endblock %}

