{% extends "base.html" %}

{% block title %}{{ reporte.folio }} - Kinessia Hub{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_reportes_ventas.css') }}">
{% endblock %}
{% block content %}
{# Calcular equivalente en pesos de d贸lares #}
{% set dolares = reporte.deposito_dolares_efectivo|float or 0 %}
{% set tipo_cambio = reporte.tipo_cambio|float or 0 %}
{% set equivalente_pesos = dolares * tipo_cambio %}
{% set efectivo_menos_dolares = (reporte.total_efectivo|float) - equivalente_pesos %}

<div class="reportes-container">
    <!-- Header -->
    <div class="page-header no-print">
        <div class="page-title">
            <span class="icon"><i class="fas fa-file-alt"></i></span>
            <div>
                <h1>{{ reporte.folio }}</h1>
                <p>Reporte de Ventas - {{ reporte.fecha.strftime('%d/%m/%Y') }}</p>
            </div>
        </div>
        <div class="header-actions">
            <span class="badge badge-{{ reporte.estatus }} badge-lg">
                {{ reporte.estatus|capitalize }}
            </span>
            {% if reporte.puede_editar %}
            <a href="{{ url_for('main.editar_reporte_venta', id=reporte.id) }}" class="btn-primary">
                <i class="fas fa-edit"></i> Editar
            </a>
            {% endif %}
            <button onclick="window.print()" class="btn-secondary">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <a href="{{ url_for('main.reportes_ventas') }}" class="btn-outline">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Reporte Estilo PDF -->
    <div class="reporte-pdf">
        <!-- Encabezado del Reporte -->
        <div class="reporte-header">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" onerror="this.style.display='none'">
                <span class="logo-text">VIAJES KINESSIA</span>
            </div>
            <div class="titulo-section">
                <h2>REPORTE DE VENTAS UNIFICADO</h2>
                <div class="info-header">
                    <div class="info-item">
                        <span class="label">FECHA:</span>
                        <span class="value">{{ reporte.fecha.strftime('%d-%b-%y')|upper }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">AGENTE:</span>
                        <span class="value">{{ reporte.usuario.nombre|upper if reporte.usuario else '---' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Principal -->
        <div class="tabla-reporte-container">
            <table class="tabla-reporte">
                <thead>
                    <tr class="header-group">
                        <th colspan="5" class="grupo-concepto">CONCEPTO</th>
                        <th colspan="4" class="grupo-costo">COSTO BOLETO</th>
                        <th colspan="5" class="grupo-otros">OTROS</th>
                        <th colspan="3" class="grupo-pago">FORMA DE PAGO</th>
                        <th rowspan="2" class="total-header">TOTAL</th>
                    </tr>
                    <tr class="header-cols">
                        <th>CLAVE</th>
                        <th>#</th>
                        <th>RESERVA</th>
                        <th>No. RECIBO</th>
                        <th>PAPELETA</th>
                        <th>BSP</th>
                        <th>VOLARIS</th>
                        <th>VIVAEROBUS</th>
                        <th>COMPRA TC</th>
                        <th>CARGO EXP</th>
                        <th>CARGO 3.15%</th>
                        <th>SEGUROS</th>
                        <th>HOTELES</th>
                        <th>TERRESTRE</th>
                        <th>PAGO TC</th>
                        <th>VOUCHER TC</th>
                        <th>EFECTIVO</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in detalles %}
                    <tr>
                        <td><strong>{{ d.clave_aerolinea }}</strong></td>
                        <td>{{ d.num_boletos }}</td>
                        <td>{{ d.reserva }}</td>
                        <td>{{ d.num_recibo }}</td>
                        <td>{{ d.num_papeleta }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_bsp|float) if d.monto_bsp else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_volaris|float) if d.monto_volaris else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_vivaerobus|float) if d.monto_vivaerobus else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_compra_tc|float) if d.monto_compra_tc else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.cargo_expedicion|float) if d.cargo_expedicion else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.cargo_315|float) if d.cargo_315 else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_seguros|float) if d.monto_seguros else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_hoteles_paquetes|float) if d.monto_hoteles_paquetes else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.monto_transporte_terrestre|float) if d.monto_transporte_terrestre else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.pago_directo_tc|float) if d.pago_directo_tc else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.voucher_tc|float) if d.voucher_tc else '' }}</td>
                        <td class="monto">{{ '${:,.2f}'.format(d.efectivo|float) if d.efectivo else '' }}</td>
                        <td class="monto total-col">${{ '{:,.2f}'.format(d.total_linea|float) }}</td>
                    </tr>
                    {% endfor %}
                    {% for i in range(10 - detalles|length) %}
                    {% if i >= 0 %}
                    <tr class="empty-row">
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="totales-row">
                        <td><strong>TOTAL</strong></td>
                        <td><strong>{{ reporte.total_boletos }}</strong></td>
                        <td colspan="3"></td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_bsp|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_volaris|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_vivaerobus|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_compra_tc|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_cargo_expedicion|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_cargo_315|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_seguros|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_hoteles_paquetes|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_transporte_terrestre|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_pago_directo_tc|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_voucher_tc|float) }}</td>
                        <td class="monto">${{ '{:,.2f}'.format(reporte.total_efectivo|float) }}</td>
                        <td class="monto total-col"><strong>${{ '{:,.2f}'.format(reporte.total_general|float) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Secci贸n Inferior -->
        <div class="reporte-footer-section">
            <div class="footer-left">
                <!-- Totales con l贸gica de d贸lares -->
                <div class="totales-box">
                    <div class="total-row">
                        <span class="label">TOTAL EFECTIVO</span>
                        <span class="value">${{ '{:,.2f}'.format(reporte.total_efectivo|float) }}</span>
                    </div>
                    
                    {% if dolares > 0 and tipo_cambio > 0 %}
                    <div class="total-row sub" style="color: #dc3545;">
                        <span class="label">(-) DLARES EN PESOS</span>
                        <span class="value">-${{ '{:,.2f}'.format(equivalente_pesos) }}</span>
                    </div>
                    <div class="total-row highlight">
                        <span class="label">EFECTIVO PESOS NETO</span>
                        <span class="value">${{ '{:,.2f}'.format(efectivo_menos_dolares) }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="total-row sub">
                        <span class="label">DEPOSITO EFECTIVO PESOS</span>
                        <span class="value">${{ '{:,.2f}'.format(reporte.deposito_pesos_efectivo|float) }}</span>
                    </div>
                    <div class="total-row sub">
                        <span class="label">DEPOSITO CHEQUES</span>
                        <span class="value">${{ '{:,.2f}'.format(reporte.deposito_pesos_cheques|float) }}</span>
                    </div>
                    <div class="total-row sub">
                        <span class="label">VOUCHER T.C.</span>
                        <span class="value">${{ '{:,.2f}'.format(reporte.total_voucher_tc|float) }}</span>
                    </div>
                    
                    <div class="total-row grand-total">
                        <span class="label">TOTAL GENERAL</span>
                        <span class="value">${{ '{:,.2f}'.format(reporte.total_general|float) }}</span>
                    </div>
                </div>

                <!-- D贸lares -->
                {% if dolares > 0 %}
                <div class="dolares-box">
                    <span class="label"> DLARES</span>
                    <div class="dolar-row">
                        <span>CANTIDAD USD</span>
                        <span><strong>${{ '{:,.2f}'.format(dolares) }}</strong></span>
                    </div>
                    <div class="dolar-row">
                        <span>TIPO DE CAMBIO</span>
                        <span>${{ '{:,.4f}'.format(tipo_cambio) }}</span>
                    </div>
                    <div class="dolar-row equivalente">
                        <span>EQUIVALENTE MXN</span>
                        <span>${{ '{:,.2f}'.format(equivalente_pesos) }}</span>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="footer-center">
                <!-- Boletos por aerol铆nea -->
                <div class="aerolineas-box">
                    <div class="aerolineas-header">
                        <span>CONCEPTO</span>
                        <span>CLAVE</span>
                        <span>BOLETOS</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Volaris</span>
                        <span>Y4</span>
                        <span>{{ boletos_aerolinea.get('Y4', 0) }}</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Viva Aerobus</span>
                        <span>VI</span>
                        <span>{{ boletos_aerolinea.get('VI', 0) + boletos_aerolinea.get('VB', 0) }}</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Aerom茅xico</span>
                        <span>AM</span>
                        <span>{{ boletos_aerolinea.get('AM', 0) }}</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Internacionales</span>
                        <span>INT</span>
                        <span>{{ boletos_aerolinea.get('INT', 0) }}</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Hotel</span>
                        <span>HT</span>
                        <span>{{ boletos_aerolinea.get('HT', 0) }}</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Paquete</span>
                        <span>PK</span>
                        <span>{{ boletos_aerolinea.get('PK', 0) }}</span>
                    </div>
                    <div class="aerolinea-row">
                        <span>Seguro</span>
                        <span>SG</span>
                        <span>{{ boletos_aerolinea.get('SG', 0) }}</span>
                    </div>
                    <div class="aerolinea-row total">
                        <span><strong>TOTAL BOLETOS</strong></span>
                        <span></span>
                        <span><strong>{{ reporte.total_boletos }}</strong></span>
                    </div>
                    <div class="aerolinea-row total">
                        <span><strong>TOTAL RECIBOS</strong></span>
                        <span></span>
                        <span><strong>{{ reporte.total_recibos }}</strong></span>
                    </div>
                </div>
            </div>

            <div class="footer-right">
                <!-- Datos de dep贸sito -->
                <div class="deposito-box">
                    <h4>DEPSITOS</h4>
                    
                    <div class="deposito-row">
                        <span>BANCO</span>
                        <span>SANTANDER</span>
                    </div>
                    <div class="deposito-row">
                        <span>CUENTA</span>
                        <span>{{ reporte.cuenta_deposito or 'Suc. 0002 cta 7568815' }}</span>
                    </div>
                    <div class="deposito-row">
                        <span>NOMBRE</span>
                        <span style="font-size: 0.7rem;">VIAJES INTERNACIONALES MONARCA, S.A. DE C.V.</span>
                    </div>
                    
                    <hr style="margin: 0.75rem 0; border: none; border-top: 1px dashed #ccc;">
                    
                    <div class="deposito-row">
                        <span>PESOS EFECTIVO</span>
                        <span><strong>${{ '{:,.2f}'.format(reporte.deposito_pesos_efectivo|float) }}</strong></span>
                    </div>
                    {% if dolares > 0 %}
                    <div class="deposito-row">
                        <span>DLARES</span>
                        <span><strong>${{ '{:,.2f}'.format(dolares) }} USD</strong></span>
                    </div>
                    {% endif %}
                    <div class="deposito-row">
                        <span>CHEQUES</span>
                        <span><strong>${{ '{:,.2f}'.format(reporte.deposito_pesos_cheques|float) }}</strong></span>
                    </div>
                    
                    <hr style="margin: 0.75rem 0; border: none; border-top: 1px dashed #ccc;">
                    
                    <div class="deposito-row">
                        <span>FECHA</span>
                        <span>{{ reporte.fecha.strftime('%d-%b-%Y')|upper }}</span>
                    </div>
                    <div class="deposito-row">
                        <span>AGENTE</span>
                        <span>{{ reporte.usuario.nombre|upper if reporte.usuario else '---' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notas -->
        {% if reporte.notas %}
        <div class="notas-section">
            <strong><i class="fas fa-sticky-note"></i> Notas:</strong> {{ reporte.notas }}
        </div>
        {% endif %}

        <!-- Aprobaci贸n -->
        {% if reporte.estatus == 'aprobado' %}
        <div class="aprobacion-section">
            <i class="fas fa-check-circle"></i>
            <strong>APROBADO</strong> por {{ reporte.aprobador.nombre if reporte.aprobador else '---' }} 
            el {{ reporte.fecha_aprobacion.strftime('%d/%m/%Y %H:%M') if reporte.fecha_aprobacion else '' }}
        </div>
        {% endif %}
    </div>

    <!-- Acciones Admin -->
    {% if reporte.estatus == 'enviado' and current_user.es_admin() %}
    <div class="admin-actions no-print">
        <h3><i class="fas fa-user-shield"></i> Acciones de Administrador</h3>
        <div class="actions-row">
            <form action="{{ url_for('main.aprobar_reporte_venta', id=reporte.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn-success">
                    <i class="fas fa-check"></i> Aprobar Reporte
                </button>
            </form>
            <form action="{{ url_for('main.rechazar_reporte_venta', id=reporte.id) }}" method="POST" 
                  style="display:inline;" onsubmit="return confirmarRechazo(this)">
                <input type="hidden" name="motivo" id="motivoRechazo">
                <button type="submit" class="btn-danger">
                    <i class="fas fa-times"></i> Rechazar
                </button>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
<script>
function confirmarRechazo(form) {
    var motivo = prompt('Ingresa el motivo del rechazo:');
    if (motivo && motivo.trim().length > 0) {
        document.getElementById('motivoRechazo').value = motivo;
        return true;
    }
    return false;
}
</script>
{% endblock %}