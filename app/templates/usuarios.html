{% extends "base.html" %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stylesusers.css') }}">
{% endblock %}

{% block content %}
<div class="usuarios-page">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title">
            <span class="icon">üë•</span>
            <div>
                <h1>Gesti√≥n de Usuarios</h1>
                <p>Administra los usuarios del sistema</p>
            </div>
        </div>
        {% if current_user.es_admin() %}
        <button type="button" class="btn-primary" onclick="abrirModalNuevo()">
            + Nuevo Usuario
        </button>
        {% endif %}
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
        <div class="filtro-group">
            <label>Buscar:</label>
            <input type="text" id="filtroNombre" placeholder="Nombre o correo..." onkeyup="filtrarUsuarios()">
        </div>
        <div class="filtro-group">
            <label>Rol:</label>
            <select id="filtroRol" onchange="filtrarUsuarios()">
                <option value="">Todos</option>
                {% for rol in roles %}
                <option value="{{ rol.nombre }}">{{ rol.nombre|capitalize }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filtro-group">
            <label>Sucursal:</label>
            <select id="filtroSucursal" onchange="filtrarUsuarios()">
                <option value="">Todas</option>
                {% for sucursal in sucursales %}
                <option value="{{ sucursal.id }}">{{ sucursal.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filtro-group">
            <label>Estatus:</label>
            <select id="filtroEstatus" onchange="filtrarUsuarios()">
                <option value="">Todos</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
            </select>
        </div>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="stats-row">
        <div class="stat-card">
            <span class="stat-icon">üë•</span>
            <div class="stat-info">
                <span class="stat-number">{{ usuarios|length }}</span>
                <span class="stat-label">Total Usuarios</span>
            </div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">‚úÖ</span>
            <div class="stat-info">
                <span class="stat-number">{{ usuarios|selectattr('activo')|list|length }}</span>
                <span class="stat-label">Activos</span>
            </div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üö´</span>
            <div class="stat-info">
                <span class="stat-number">{{ usuarios|rejectattr('activo')|list|length }}</span>
                <span class="stat-label">Inactivos</span>
            </div>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="table-container">
        <table class="usuarios-table" id="tablaUsuarios">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Sucursal</th>
                    <th>Tarjetas Asignadas</th>
                    <th>Estatus</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr data-nombre="{{ usuario.nombre|lower }}" 
                    data-correo="{{ usuario.correo|lower }}"
                    data-rol="{{ usuario.rol|lower }}"
                    data-sucursal="{{ usuario.sucursal_id or '' }}"
                    data-activo="{{ 'activo' if usuario.activo else 'inactivo' }}">
                    <td class="usuario-cell">
                        <div class="usuario-avatar">
                            {{ usuario.nombre[0]|upper }}
                        </div>
                        <div class="usuario-info">
                            <span class="nombre">{{ usuario.nombre }}</span>
                            <span class="correo">{{ usuario.correo }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge-rol {{ usuario.rol|lower }}">
                            {% if usuario.rol in ['administrador', 'admin'] %}üëë{% endif %}
                            {% if usuario.rol == 'director' %}üéØ{% endif %}
                            {% if usuario.rol == 'gerente' %}üìä{% endif %}
                            {% if usuario.rol == 'agente' %}üë§{% endif %}
                            {% if usuario.rol == 'sistemas' %}üîß{% endif %}
                            {{ usuario.rol|capitalize }}
                        </span>
                    </td>
                    <td>
                        {% if usuario.sucursal %}
                            <span class="badge-sucursal">üìç {{ usuario.sucursal.nombre }}</span>
                        {% else %}
                            <span class="sin-asignar">Sin asignar</span>
                        {% endif %}
                    </td>
                    <td>
                        {% set tarjetas_count = usuario.tarjetas_asignadas|selectattr('activo')|list|length %}
                        {% if tarjetas_count > 0 %}
                            <span class="badge-tarjetas" onclick="verTarjetasUsuario({{ usuario.id }}, '{{ usuario.nombre }}')">
                                üí≥ {{ tarjetas_count }} tarjeta{{ 's' if tarjetas_count > 1 else '' }}
                            </span>
                        {% else %}
                            <span class="sin-tarjetas">Sin tarjetas</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if usuario.activo %}
                            <span class="badge-activo">‚úÖ Activo</span>
                        {% else %}
                            <span class="badge-inactivo">üö´ Inactivo</span>
                        {% endif %}
                    </td>
                    <td class="acciones-cell">
                        <button type="button" class="btn-action btn-view" title="Ver detalle" 
                                onclick="verUsuario({{ usuario.id }})">üëÅÔ∏è</button>
                        {% if current_user.es_admin() %}
                        <button type="button" class="btn-action btn-edit" title="Editar" 
                                onclick="editarUsuario({{ usuario.id }})">‚úèÔ∏è</button>
                        <button type="button" class="btn-action btn-tarjetas" title="Asignar tarjetas" 
                                onclick="asignarTarjetas({{ usuario.id }}, '{{ usuario.nombre }}')">üí≥</button>
                        {% if usuario.id != current_user.id %}
                        <button type="button" class="btn-action {{ 'btn-disable' if usuario.activo else 'btn-enable' }}" 
                                title="{{ 'Desactivar' if usuario.activo else 'Activar' }}"
                                onclick="toggleEstatus({{ usuario.id }}, {{ 'true' if usuario.activo else 'false' }}, '{{ usuario.nombre }}')">
                            {{ 'üö´' if usuario.activo else '‚úÖ' }}
                        </button>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo Usuario -->
{% if current_user.es_admin() %}
<div class="modal-overlay" id="modalNuevo">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üë§ Nuevo Usuario</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalNuevo')">&times;</button>
        </div>
        <form action="{{ url_for('main.nuevo_usuario') }}" method="POST" id="formNuevoUsuario">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nuevo_nombre">Nombre completo *</label>
                        <input type="text" id="nuevo_nombre" name="nombre" required placeholder="Ej: Juan P√©rez Garc√≠a">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nuevo_correo">Correo electr√≥nico *</label>
                        <input type="email" id="nuevo_correo" name="correo" required placeholder="correo@empresa.com">
                    </div>
                </div>
                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="nuevo_contrasena">Contrase√±a *</label>
                        <input type="password" id="nuevo_contrasena" name="contrasena" required minlength="6" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label for="nuevo_telefono">Tel√©fono</label>
                        <input type="tel" id="nuevo_telefono" name="telefono" placeholder="(646) 123-4567">
                    </div>
                </div>
                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="nuevo_rol">Rol *</label>
                        <select id="nuevo_rol" name="rol_id" required>
                            <option value="">Selecciona un rol...</option>
                            {% for rol in roles %}
                            <option value="{{ rol.id }}">{{ rol.nombre|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nuevo_sucursal">Sucursal *</label>
                        <select id="nuevo_sucursal" name="sucursal_id" required>
                            <option value="">Selecciona sucursal...</option>
                            {% for sucursal in sucursales %}
                            <option value="{{ sucursal.id }}">{{ sucursal.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nuevo_tipo_agente">Tipo de agente</label>
                        <select id="nuevo_tipo_agente" name="tipo_agente">
                            <option value="">No aplica</option>
                            <option value="in_house">In House (Oficina)</option>
                            <option value="home_office">Home Office</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalNuevo')">Cancelar</button>
                <button type="submit" class="btn-submit">Crear Usuario</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal-overlay" id="modalEditar">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Usuario</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalEditar')">&times;</button>
        </div>
        <form action="" method="POST" id="formEditarUsuario">
            <input type="hidden" id="editar_id" name="id">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editar_nombre">Nombre completo *</label>
                        <input type="text" id="editar_nombre" name="nombre" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editar_correo">Correo electr√≥nico *</label>
                        <input type="email" id="editar_correo" name="correo" required>
                    </div>
                </div>
                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="editar_telefono">Tel√©fono</label>
                        <input type="tel" id="editar_telefono" name="telefono">
                    </div>
                    <div class="form-group">
                        <label for="editar_tipo_agente">Tipo de agente</label>
                        <select id="editar_tipo_agente" name="tipo_agente">
                            <option value="">No aplica</option>
                            <option value="in_house">In House (Oficina)</option>
                            <option value="home_office">Home Office</option>
                        </select>
                    </div>
                </div>
                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="editar_rol">Rol *</label>
                        <select id="editar_rol" name="rol_id" required>
                            {% for rol in roles %}
                            <option value="{{ rol.id }}">{{ rol.nombre|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editar_sucursal">Sucursal *</label>
                        <select id="editar_sucursal" name="sucursal_id" required>
                            {% for sucursal in sucursales %}
                            <option value="{{ sucursal.id }}">{{ sucursal.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editar_contrasena">Nueva contrase√±a (dejar vac√≠o para mantener)</label>
                        <input type="password" id="editar_contrasena" name="contrasena" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <small>Solo llenar si desea cambiar la contrase√±a</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalEditar')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Asignar Tarjetas -->
<div class="modal-overlay" id="modalTarjetas">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>üí≥ Asignar Tarjetas a <span id="tarjetas_usuario_nombre"></span></h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalTarjetas')">&times;</button>
        </div>
        <form action="" method="POST" id="formAsignarTarjetas">
            <input type="hidden" id="tarjetas_usuario_id" name="usuario_id">
            <div class="modal-body">
                <p class="modal-description">Selecciona las tarjetas que este usuario puede utilizar:</p>
                <div class="tarjetas-grid" id="tarjetasGrid">
                    {% for tarjeta in tarjetas %}
                    <label class="tarjeta-checkbox">
                        <input type="checkbox" name="tarjetas[]" value="{{ tarjeta.id }}">
                        <div class="tarjeta-card">
                            <div class="tarjeta-icon {{ 'visa' if 'visa' in (tarjeta.nombre_tarjeta or '')|lower else 'amex' if 'amex' in (tarjeta.nombre_tarjeta or '')|lower else 'default' }}">
                                üí≥
                            </div>
                            <div class="tarjeta-info">
                                <span class="nombre">{{ tarjeta.nombre_tarjeta }}</span>
                                <span class="numero">**** {{ tarjeta.numero_tarjeta }}</span>
                            </div>
                            <div class="check-mark">‚úì</div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalTarjetas')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar Asignaci√≥n</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Toggle Estatus -->
<div class="modal-overlay" id="modalToggleEstatus">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3 id="toggle_titulo">üö´ Desactivar Usuario</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalToggleEstatus')">&times;</button>
        </div>
        <form action="" method="POST" id="formToggleEstatus">
            <input type="hidden" id="toggle_usuario_id" name="usuario_id">
            <input type="hidden" id="toggle_accion" name="accion">
            <div class="modal-body">
                <p id="toggle_mensaje">¬øEst√°s seguro de desactivar a este usuario?</p>
                <div class="form-group">
                    <label for="toggle_motivo">Motivo *</label>
                    <textarea id="toggle_motivo" name="motivo" required minlength="10" 
                              placeholder="Explica el motivo..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalToggleEstatus')">Cancelar</button>
                <button type="submit" class="btn-danger" id="toggle_btn">Desactivar</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Modal Ver Usuario (disponible para todos) -->
<div class="modal-overlay" id="modalVer">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üë§ Detalle de Usuario</h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalVer')">&times;</button>
        </div>
        <div class="modal-body" id="modalVerContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Cargando...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="cerrarModal('modalVer')">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal Ver Tarjetas Usuario -->
<div class="modal-overlay" id="modalVerTarjetas">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí≥ Tarjetas de <span id="ver_tarjetas_nombre"></span></h3>
            <button type="button" class="modal-close" onclick="cerrarModal('modalVerTarjetas')">&times;</button>
        </div>
        <div class="modal-body" id="modalVerTarjetasContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Cargando...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="cerrarModal('modalVerTarjetas')">Cerrar</button>
        </div>
    </div>
</div>

<script>
// === FILTROS ===
function filtrarUsuarios() {
    const nombre = document.getElementById('filtroNombre').value.toLowerCase();
    const rol = document.getElementById('filtroRol').value.toLowerCase();
    const sucursal = document.getElementById('filtroSucursal').value;
    const estatus = document.getElementById('filtroEstatus').value;
    
    const filas = document.querySelectorAll('#tablaUsuarios tbody tr');
    
    filas.forEach(fila => {
        const dataNombre = fila.dataset.nombre;
        const dataCorreo = fila.dataset.correo;
        const dataRol = fila.dataset.rol;
        const dataSucursal = fila.dataset.sucursal;
        const dataActivo = fila.dataset.activo;
        
        let mostrar = true;
        
        if (nombre && !dataNombre.includes(nombre) && !dataCorreo.includes(nombre)) {
            mostrar = false;
        }
        if (rol && dataRol !== rol) {
            mostrar = false;
        }
        if (sucursal && dataSucursal !== sucursal) {
            mostrar = false;
        }
        if (estatus && dataActivo !== estatus) {
            mostrar = false;
        }
        
        fila.style.display = mostrar ? '' : 'none';
    });
}

// === MODALES ===
function abrirModal(id) {
    document.getElementById(id).classList.add('active');
}

function cerrarModal(id) {
    document.getElementById(id).classList.remove('active');
}

function abrirModalNuevo() {
    document.getElementById('formNuevoUsuario').reset();
    abrirModal('modalNuevo');
}

// === VER USUARIO ===
function verUsuario(id) {
    abrirModal('modalVer');
    document.getElementById('modalVerContent').innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Cargando...</p>
        </div>
    `;
    
    fetch(`/api/usuario/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('modalVerContent').innerHTML = `<p class="error">‚ùå ${data.error}</p>`;
                return;
            }
            
            document.getElementById('modalVerContent').innerHTML = `
                <div class="usuario-detail">
                    <div class="detail-header">
                        <div class="avatar-large">${data.nombre[0].toUpperCase()}</div>
                        <div class="info">
                            <h2>${data.nombre}</h2>
                            <p>${data.correo}</p>
                            <span class="badge-rol ${data.rol.toLowerCase()}">${data.rol}</span>
                            ${data.activo ? '<span class="badge-activo">‚úÖ Activo</span>' : '<span class="badge-inactivo">üö´ Inactivo</span>'}
                        </div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="label">üìç Sucursal</span>
                            <span class="value">${data.sucursal || 'Sin asignar'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">üìû Tel√©fono</span>
                            <span class="value">${data.telefono || 'No registrado'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">üè¢ Tipo Agente</span>
                            <span class="value">${data.tipo_agente || 'No aplica'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">üí≥ Tarjetas Asignadas</span>
                            <span class="value">${data.tarjetas_count} tarjeta(s)</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">üìÖ Fecha Registro</span>
                            <span class="value">${data.created_at}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">üîÑ √öltima Actualizaci√≥n</span>
                            <span class="value">${data.updated_at}</span>
                        </div>
                    </div>
                    ${data.tarjetas.length > 0 ? `
                    <div class="detail-section">
                        <h4>üí≥ Tarjetas Asignadas</h4>
                        <div class="tarjetas-list">
                            ${data.tarjetas.map(t => `
                                <div class="tarjeta-item">
                                    <span class="icon">üí≥</span>
                                    <span>${t.nombre} (**** ${t.numero})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('modalVerContent').innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
        });
}

// === EDITAR USUARIO ===
function editarUsuario(id) {
    fetch(`/api/usuario/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            document.getElementById('editar_id').value = data.id;
            document.getElementById('editar_nombre').value = data.nombre;
            document.getElementById('editar_correo').value = data.correo;
            document.getElementById('editar_telefono').value = data.telefono || '';
            document.getElementById('editar_tipo_agente').value = data.tipo_agente || '';
            document.getElementById('editar_rol').value = data.rol_id;
            document.getElementById('editar_sucursal').value = data.sucursal_id || '';
            document.getElementById('editar_contrasena').value = '';
            
            document.getElementById('formEditarUsuario').action = `/usuarios/editar/${data.id}`;
            
            abrirModal('modalEditar');
        })
        .catch(error => {
            alert('Error al cargar usuario: ' + error.message);
        });
}

// === ASIGNAR TARJETAS ===
function asignarTarjetas(usuarioId, nombre) {
    document.getElementById('tarjetas_usuario_id').value = usuarioId;
    document.getElementById('tarjetas_usuario_nombre').textContent = nombre;
    document.getElementById('formAsignarTarjetas').action = `/usuarios/${usuarioId}/tarjetas`;
    
    // Desmarcar todas
    document.querySelectorAll('#tarjetasGrid input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Cargar tarjetas actuales
    fetch(`/api/usuario/${usuarioId}/tarjetas`)
        .then(response => response.json())
        .then(data => {
            if (data.tarjetas) {
                data.tarjetas.forEach(tarjetaId => {
                    const cb = document.querySelector(`#tarjetasGrid input[value="${tarjetaId}"]`);
                    if (cb) cb.checked = true;
                });
            }
            abrirModal('modalTarjetas');
        })
        .catch(() => {
            abrirModal('modalTarjetas');
        });
}

// === VER TARJETAS DE USUARIO ===
function verTarjetasUsuario(usuarioId, nombre) {
    document.getElementById('ver_tarjetas_nombre').textContent = nombre;
    abrirModal('modalVerTarjetas');
    
    document.getElementById('modalVerTarjetasContent').innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Cargando...</p>
        </div>
    `;
    
    fetch(`/api/usuario/${usuarioId}`)
        .then(response => response.json())
        .then(data => {
            if (data.tarjetas && data.tarjetas.length > 0) {
                document.getElementById('modalVerTarjetasContent').innerHTML = `
                    <div class="tarjetas-list-detail">
                        ${data.tarjetas.map(t => `
                            <div class="tarjeta-detail-item">
                                <div class="tarjeta-icon">üí≥</div>
                                <div class="tarjeta-info">
                                    <span class="nombre">${t.nombre}</span>
                                    <span class="numero">**** ${t.numero}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('modalVerTarjetasContent').innerHTML = `
                    <p class="empty-message">Este usuario no tiene tarjetas asignadas.</p>
                `;
            }
        })
        .catch(error => {
            document.getElementById('modalVerTarjetasContent').innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
        });
}

// === TOGGLE ESTATUS ===
function toggleEstatus(usuarioId, activo, nombre) {
    const accion = activo ? 'desactivar' : 'activar';
    
    document.getElementById('toggle_usuario_id').value = usuarioId;
    document.getElementById('toggle_accion').value = accion;
    document.getElementById('toggle_titulo').textContent = activo ? 'üö´ Desactivar Usuario' : '‚úÖ Activar Usuario';
    document.getElementById('toggle_mensaje').textContent = `¬øEst√°s seguro de ${accion} a ${nombre}?`;
    document.getElementById('toggle_btn').textContent = activo ? 'Desactivar' : 'Activar';
    document.getElementById('toggle_btn').className = activo ? 'btn-danger' : 'btn-submit';
    document.getElementById('toggle_motivo').value = '';
    
    document.getElementById('formToggleEstatus').action = `/usuarios/${usuarioId}/toggle-estatus`;
    
    abrirModal('modalToggleEstatus');
}

// === CERRAR MODALES ===
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});
</script>
{% endblock %}